---
layout: post
title: Error handling in MVC
date: '2012-08-02T21:59:00.001+01:00'
author: Frans Lytzen
tags: 
modified_time: '2012-08-02T21:59:38.627+01:00'
blogger_id: tag:blogger.com,1999:blog-8302357413081836531.post-2281625063349525097
---

Handling errors with MVC3 can be very confusing because many different factors influence what will actually be presented to the user. There are lots of blog posts and stack overflow questions dealing with individual bits but I have found it difficult to get an overview of the whole thing. <br />How errors are handled and presented to the user is one thing when you just write a traditional web application, but when you get into building web services or REST APIs or even just using AJAX you need better control of how response status codes are handled and presented to the user. <br />Some of the factors that can influence what actually happens when an error occurs or you return an error status code include;<br /><br /><ul><br /><li>The setting of customErrors in web.config  </li><br /><li>Whether forms authentication is enabled (for authentication errors and status codes)  </li><br /><li>The presence of any ErrorHandler atrribute  </li><br /><li>Whether a view called "error" exists in the shared folder (if you use the default ErrorHandler attribute)  </li><br /><li>Whether you throw an exception or you return a status result, such HttpNotFoundResult or HttpStatusCodeResult  </li><br /><li>Which version of IIS you are using and whether you set TrySkipCustomIisErrors in code  </li><br /><li>Whether or not you return any body content with your error code (changes IIS behaviour) </li><br /></ul><br /><h2><br />TL;DR</h2><br />If you want the user to see that something went wrong, throw exceptions. This will be caught by error handlers and something shown to the user (assuming you have error handling switched on).<br /><br />If you want the error code to be returned to the browser, return an HttpStatusCodeResult or directly set Response.Status in your controller. You will probably also want to do this in your controller code; <br /><br /><pre class="brush: csharp;">    this.HttpContext.Response.TrySkipIisCustomErrors = true;</pre><br /><br /><br /><br /><br /><br /><br /><h2><br /></h2><br /><br /><br /><h2><br />How exceptions are presented back to the user and what influences this</h2><br /><br /><br />In ASP.Net applications you traditionally have a block like this in web.config:<br /><br /><pre class="brush: xml;">&lt;configuration&gt;<br />   &lt;system.web&gt;<br />      &lt;customErrors defaultRedirect="GenericError.htm" mode="On"&gt;<br />         &lt;error statusCode="404" redirect="NotFound.htm"/&gt;<br />      &lt;/customErrors&gt;<br />   &lt;/system.web&gt;<br />&lt;/configuration&gt;</pre><br /><pre class="brush: xml;"><br /></pre><br /><br /><br />In a brand-new default MVC3 installation you will indeed find that if you do this:<br /><br /><pre class="brush: csharp;"><br />throw new HttpException(500, "My Exception Error");</pre><br />then you will indeed be redirected to the NotFound.htm page. More specifically, a "302 Found" status code will be sent back to the browser with the location of the <br /><br /><h2><br />How to return status codes and handle IIS interference</h2><br /><br /><br /><br /><br /><br /><br /><h2><br />The very special case of 401 Unathorised</h2><br /><br /><br /><br /><br /><br /><br /><br />When the ErrorHandlerAttribute returns the view, it sets the status to 500 code and replaces the status message and the body of the response with contents of the error view, but it does not change the URL (no 302)<br /><br /><br /><br />When you throw an HTTP Exception, the "status description" you pass in does not become part of the status code!<br /><br /><br /><br /><br />Install plain ELMAH with the MVC default errror attribute and Custom Errors = ON <br />Now, a normal exception is intercepted by the ErrorHandlerAttribute as before and you get the error view. This does not get logged in ELMAH. <br />Throwing a 404 exception will redirect to the normal error page and will log in Elmah. <br />If you delete the error view but leave the normal error handler in place then you will get an error in the ELMAH log that the "error" view does not exist. <br />If you install the Elmah MVC package, the default error handler attribute gets replaced with one that essentially behaves the same (custom error view for 500 only) but does log them in Elmah. 