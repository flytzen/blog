<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Azure SQL Failover Setup</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="Configure a replica of an Azure SQL database in another region to protect you from failures." /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Azure SQL Failover Setup</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2022-12-01T00:00:00+00:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">01 Dec 2022</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#Azure" class="icon__txt tag">Azure</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> <h1 id="tldr">TL;DR;</h1> <p>Azure SQL Failover Groups is a managed version of Geo Replication which enables both automatic and manual failover.</p> <ol> <li>Create a SQL Server in another region</li> <li>Create a Failover Group for a database currently on the primary server</li> <li>Check your authentication works on both servers</li> <li>Change your connection string to point to <code class="highlighter-rouge">[failover-group-name].database.windows.net</code></li> </ol> <h1 id="set-up-test-server">Set up test server</h1> <p>If want to just try this out, use this bash script to create a server and database to experiment with. Note; Even if you don’t have the Azure CLI on your machine, you can run all of this from the <a href="https://learn.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a> very easily.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">group</span><span class="o">=</span>fl-20221201-sqlfailover
<span class="nv">location</span><span class="o">=</span>northeurope
<span class="nv">sqlServerName</span><span class="o">=</span>failovertest-uat-eun-ss
<span class="nv">sqlDbName</span><span class="o">=</span>failovertest-uat-db
<span class="nv">sqlUsername</span><span class="o">=[</span>sql user name of your choice]
<span class="nv">sqlPassword</span><span class="o">=[</span>strong password]
<span class="nv">sqlCapacity</span><span class="o">=</span>10 <span class="c">#20 = S1, 10 = S0</span>

az group create <span class="nt">--name</span> <span class="nv">$group</span> <span class="nt">--location</span> <span class="nv">$location</span>

az sql server create <span class="nt">--name</span> <span class="nv">$sqlServerName</span> <span class="nt">--location</span> <span class="nv">$location</span> <span class="nt">--admin-user</span> <span class="nv">$sqlUsername</span> <span class="nt">--admin-password</span> <span class="nv">$sqlPassword</span> <span class="nt">-g</span> <span class="nv">$group</span>

az sql db create <span class="nt">--name</span> <span class="nv">$sqlDbName</span> <span class="nt">--server</span> <span class="nv">$sqlServerName</span> <span class="nt">--edition</span> Standard <span class="nt">--capacity</span> <span class="nv">$sqlCapacity</span> <span class="nt">-g</span> <span class="nv">$group</span>
</code></pre></div></div> <h1 id="auth-heads-up">Auth heads-up</h1> <p>Before you go any further it is important to stop for a minute and discuss authentication to avoid problems later.<br /> The failover is essentially just a bit of network routing magic: When you connect to the Failover connection string, it just routes you to the currently primary server. This means you need to take care that your applications credentials works correctly on both servers. Otherwise, everything will break when you fail over.</p> <h2 id="using-server-administrator-and-dbo">Using server administrator and dbo</h2> <p>If your application just uses the “SQL Server Administrator” login and defaults to everything in SQL (i.e. using “dbo” at the database level) then it’s relatively straight-forward: Just make sure you use the exact same SQL Admininistrator username and password on both servers.</p> <p>* You are not really supposed to do this! Your application should have a different user, with different permissions etc. In practice, though, many applications use Azure SQL exactly like this.</p> <h2 id="using-managed-identity">Using Managed Identity</h2> <p>If you use Managed Identity (or other AD accounts) to access the database, it should “just work”. When you do <code class="highlighter-rouge">CREATE USER [user] FROM EXTERNAL PROVIDER</code> then it is created as a “Contained User” in the database, meaning it doesn’t create a “login” on the SQL Server itself.</p> <p>That said - do test it, preferably in a test environment.</p> <p><a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-sql">Managed Identity with Azure SQL</a></p> <h2 id="using-your-own-sql-users">Using your own SQL users</h2> <p>If you have created your own SQL User for your application (and, indeed, others) and you <em>didn’t</em> create them as “Contained Users” then you need to do some more manual work. See <a href="https://learn.microsoft.com/en-us/azure/azure-sql/database/active-geo-replication-security-configure?view=azuresql">this Microsoft documentation</a> for more details.</p> <h1 id="set-up-fail-over">set up fail over</h1> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">group</span><span class="o">=</span>fl-20221201-sqlfailover
<span class="nv">failoverlocation</span><span class="o">=</span>westeurope
<span class="nv">existingSqlServerName</span><span class="o">=</span>failovertest-uat-eun-ss
<span class="nv">failoverSqlServerName</span><span class="o">=</span>failovertest-uat-euw-ss
<span class="nv">failoverGroupName</span><span class="o">=</span>failovertest-uat-fog
<span class="nv">sqlDbName</span><span class="o">=</span>failovertest-uat-db <span class="c"># name of the *existing* database</span>
<span class="nv">sqlUsername</span><span class="o">=[</span>sql user name of your choice] <span class="c"># See auth section above. May need to be the same as the primary</span>
<span class="nv">sqlPassword</span><span class="o">=[</span>strong password] <span class="c"># See auth section above. May need to be the same as the primary</span>

az sql server create <span class="nt">--name</span> <span class="nv">$failoverSqlServerName</span> <span class="nt">--location</span> <span class="nv">$failoverlocation</span> <span class="nt">--admin-user</span> <span class="nv">$sqlUsername</span> <span class="nt">--admin-password</span> <span class="nv">$sqlPassword</span> <span class="nt">-g</span> <span class="nv">$group</span>

az sql failover-group create <span class="nt">--name</span> <span class="nv">$failoverGroupName</span> <span class="nt">--partner-server</span> <span class="nv">$failoverSqlServerName</span> <span class="nt">--server</span> <span class="nv">$existingSqlServerName</span> <span class="nt">--add-db</span> <span class="nv">$sqlDbName</span> <span class="nt">--failover-policy</span> Automatic <span class="nt">-g</span> <span class="nv">$group</span>
</code></pre></div></div> <p><strong>Remember to look at vNets and firewall rules and make sure they match!</strong></p> <h1 id="change-connection-string">Change connection string</h1> <p>Final step is to change the connection string in your application to be <code class="highlighter-rouge">[failover-group-name].database.windows.net</code>. This will connect your application to whichever database is currently primary and will automatically redirect if the servers fail over.</p> <h1 id="failover">Failover</h1> <h2 id="automatic-fail-over">Automatic fail over</h2> <p>By default the <em>automatic</em> fail over will wait one hour before failing over.<br /> Azure will not automatically “fail back”: Once the primary region is working again, you need to manually “fail over” again, if you wish to do so. If your application is running hot-hot in both data centres it doesn’t matter, but otherwise you will incur a performance hit and ingress/egress costs by having your application and your database in different regions.</p> <h2 id="manual-failover">Manual failover</h2> <p>You can manually fail over in the Azure portal by going to either of the <em>servers</em> (not database) and select “Failover groups” from the menu.<br /> Alternatively you can use the Azure CLI like this:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">group</span><span class="o">=</span>fl-20221201-sqlfailover
<span class="nv">existingSqlServerName</span><span class="o">=</span>failovertest-uat-eun-ss
<span class="nv">failoverSqlServerName</span><span class="o">=</span>failovertest-uat-euw-ss
<span class="nv">failoverGroupName</span><span class="o">=</span>failovertest-uat-fog

<span class="c"># See which server is currently primary</span>
az sql failover-group list <span class="nt">--server</span> <span class="nv">$existingSqlServerName</span> <span class="nt">-g</span> <span class="nv">$group</span>

<span class="c"># Fail over</span>
az sql failover-group set-primary <span class="nt">--name</span> <span class="nv">$failoverGroupName</span> <span class="nt">--server</span> <span class="nv">$failoverSqlServerName</span> <span class="nt">-g</span> <span class="nv">$group</span>

<span class="c"># Fail back</span>
az sql failover-group set-primary <span class="nt">--name</span> <span class="nv">$failoverGroupName</span> <span class="nt">--server</span> <span class="nv">$existingSqlServerName</span> <span class="nt">-g</span> <span class="nv">$group</span>
</code></pre></div></div> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2022/12/01/azure-sql-failover.html'; this.page.identifier = '/2022/12/01/azure-sql-failover.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2022/12/01/azure-sql-failover.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a rel="me" href="https://github.com/flytzen" target="_blank" alt="GitHub"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a rel="me" href="https://www.linkedin.com/in/flytzen/" target="_blank" alt="LinkedIn"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a rel="me" href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon" alt="Twitter"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> <a rel="me" href="https://hachyderm.io/@flytzen" target="_blank"> <svg style="width:24px;height:24px" fill="currentColor" viewBox="0 0 24 24" class="social-icon" alt="Mastodon"> <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2022 </div> </div> </footer> </body> </html>
