<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - Using Azure Management Libraries from Azure Web Jobs</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content="In this post I will show how to set up an Azure Web Job to automatically reboot a worker role at certain times. It's just an example, you can schedule pretty much any Azure operation in this way, including shutting down VMs at the end of the day etc.Azure Management..." />
</head>


  <body>

    <header class="site-header" role="banner">
  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/talks">Talks</a>
          <a class="page-link" href="/blog">Blog</a>
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Using Azure Management Libraries from Azure Web Jobs</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2015-07-28T22:34:00+01:00" itemprop="datePublished">
          
          Jul 28, 2015
        </time>
        
          â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#Azure">Azure</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    In this post I will show how to set up an Azure Web Job to automatically reboot a worker role at certain times. It's just an example, you can schedule pretty much any Azure operation in this way, including shutting down VMs at the end of the day etc.<br /><h2>Azure Management Libraries</h2><div>Azure Management Libraries is a neat wrapper around the REST API for Azure and can be used to automate most things Azure from C#. It is also very easy to run from within an Azure Web Job so you can easily schedule it to run when you want. You will generally not find much documentation on AML apart from <a href="http://www.bradygaster.com/post/getting-started-with-the-windows-azure-management-libraries">Brady Gaster's original intro post</a> and to further confuse matters, the API and the packages have changed recently so most examples on the Web no longer work correctly. That said, it's quite easy once you get started.<br />One of the neat things is that, as I understand it, the libraries are autogenerated from the REST API so it should keep up pretty well. When you do hit an error, you will usually be able to see the REST call and response that the library tried to make in the exception which you can then cross-reference with the API documentation.<br /><br />You may be tempted to use Powershell instead of C# as it's better documented and you'd think it would be simpler and cleaner - but you may struggle to get the Azure Powershell to work in Azure Web Jobs due to some weird issue that gives you an "please connect to the Internet before running this command" error.</div><h2>Pre-requisites</h2><div><ul><li>Web Jobs run in an Azure Web App so you need one of them already set up. Note that we will need to upload a certificate to that Web App, which means <b>you need a Basic or Standard Web App</b> - which does come with a price tag! It may be possible to alter the approach I am outlining to use AD auth and so bypass this requirement. If you do this and write it up, ping me in the comments and I will link from here. It may even be possible to only temporarily upscale to upload the cert and then downscale after - I haven't tried it.</li></ul></div><h2>Authentication</h2><div>With Azure you can authenticate with an AD account or with a management certificate. For the purposes of this we will use a management certificate as it is the easiest in my opinion. The description here is a bit longwinded and may take a little while if you haven't done it before.</div><div><ol><li>Create a new Azure Management Certificate using <br /><pre class="prettyprint">makecert -sky exchange -r -n "CN=CERTIFICATENAME" -pe -a sha1 -len 2048 -ss My "CERTIFICATENAME.cer"</pre>See <a href="https://msdn.microsoft.com/en-us/library/azure/gg551722.aspx">https://msdn.microsoft.com/en-us/library/azure/gg551722.aspx</a>. You normally need to run this from your Visual Studio developer command prompt. Apparently makecert is now deprecated and you are supposed to use some odd powershell command instead - sorry if you find yourself needing to do that (do please leave a comment if you have the equivalent powershell syntax and I will update the post).<br /></li><li>Upload the resulting .cer file as a Management Certificate to the subscription that you wish to control.</li><li>Now export the certificate from your local certificate store including the private key; &nbsp;the .cer file you uploaded only has the public key and basically tells Azure that whoever has the matching private key is allowed to manage that Azure subscription. The Private key has been installed on your machine, but that isn't going to help you a whole lot when you try to run the job in an Azure Web Job.</li><ol><li>Open MMC and add the Certificate plugin for My User Account</li><li>Find the certificate you created above, in the Personal folder</li><li>Open it and choose to Copy to file (on the Details page)</li><li>Select to save the private key and specify a password</li><li>Save the .pfx file</li></ol><li>In the Azure Web App that you are going to use to run the job, upload the PFX file (in the old portal it is on the Configuration page)</li><li>Add an "app setting" for the Azure Web App with the key&nbsp;WEBSITE_LOAD_CERTIFICATES and the value should be the thumbprint of the certificate you uploaded:<br /><div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-sDGARD_9baM/VbftdsgPBRI/AAAAAAAAGEo/qEJohlr4iXU/s1600/Capture.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="80" src="http://1.bp.blogspot.com/-sDGARD_9baM/VbftdsgPBRI/AAAAAAAAGEo/qEJohlr4iXU/s400/Capture.PNG" width="400" /></a></div></div></li><ol><li>After you uploaded the certificate you should be able to see the thumbprint in the portal</li><li>Note that in some cases you get an odd character in front of the thumbprint which may not be visible when you paste it, but which will cause problems. To avoid this, paste the thumbprint into notepad and then copy it back out.</li></ol></ol><div>A bit longwinded, but we are now able to use that certificate to authenticate from the Web Job. The Web Job runs in the context of the Web App and the WEBSITE_LOAD_CERTIFICATES setting makes the specified certificate available to the Web App and the Web Job.</div></div><h2>Setting up your project in Visual Studio</h2><div>All you need is a plain old Console app. You don't need any special project type and you don't need to add the Webjobs SDK. If you want to explore the Webjobs a bit further, Hanselman has&nbsp;<a href="http://www.hanselman.com/blog/IntroducingWindowsAzureWebJobs.aspx">a nice primer</a>.<br />You need install the&nbsp;Microsoft.WindowsAzure.Management.Compute Nuget package so just do</div><pre class="prettyprint">Install-Package Microsoft.WindowsAzure.Management.Compute</pre><h2>The actual code</h2><div><pre class="prettyprint">namespace WorkerRebooter<br />{<br />    using System;<br />    using System.Security.Cryptography.X509Certificates;<br />    using Microsoft.Azure;<br />    using Microsoft.WindowsAzure.Management.Compute;<br />    using Microsoft.WindowsAzure.Management.Compute.Models;<br /><br />    class Program<br />    {<br />        private const string subscriptionId = "XXXX";<br />        private const string managementCertThumbprint = "XXXX";<br />        private const string cloudServiceName = "XXXX";<br />        private const string instanceName = "XXXX.Worker_IN_0";<br />        <br />        static void Main(string[] args)<br />        {<br />            var client = GetClient();<br />            Log($"About to reboot {instanceName}");<br />            client.Deployments.RebootRoleInstanceByDeploymentSlot(cloudServiceName, DeploymentSlot.Production, instanceName);<br />            Log($"Finished rebooting {instanceName}");<br />        }<br /><br />        private static ComputeManagementClient GetClient()<br />        {<br />            Log($"About to obtain client for sub {subscriptionId}");<br />            var cert = GetManagementCertificate(managementCertThumbprint);<br />            var creds = new CertificateCloudCredentials(subscriptionId, cert);<br />            var client = new ComputeManagementClient(creds);<br />            Log($"Obtained client for sub {subscriptionId}");<br />            return client;<br />        }<br /><br />        private static X509Certificate2 GetManagementCertificate(string thumbPrint)<br />        {<br />            Log($"About to obtain certificate {thumbPrint}");<br />            X509Store store = new X509Store(StoreName.My, StoreLocation.CurrentUser); <br />            store.Open(OpenFlags.ReadOnly);<br />            var foundList = store.Certificates.Find(X509FindType.FindByThumbprint, thumbPrint, false);<br />            var cert = foundList[0];<br />            Log($"Obtained certificate {thumbPrint}");<br />            return cert;<br />        }<br /><br />        private static void Log(string msg)<br />        {<br />            Console.WriteLine($"{DateTime.UtcNow} {msg}");<br />        }<br />    }<br />}<br /></pre></div><div>You may note that I am using "client.Deployments" - that's the main entrypoint when working with Cloud Services (PaaS). There is also a client.VirtualMachines but that is for managing IaaS VMs. It has got very similar methods and I did waste the better part of an hour not understanding why my commands didn't work on my Cloud Service :). Luckily, the exceptions showed me that the wrong REST APIs were being called which eventually made me realise my mistake.<br /><h2>Creating a Web Job</h2></div><div>If you have the Azure SDK installed, you can just right-click on your project in Visual Studio and select Publish as Azure WebJob. If not, just build your project, zip everything in your bin directory and upload it using the portal and set the schedule accordingly.</div>
  </div>

  
    
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://www.lytzen.name/2015/07/28/using-azure-management-libraries-from.html';
      this.page.identifier = '/2015/07/28/using-azure-management-libraries-from.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://flytzen.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  

  <a class="u-url" href="/2015/07/28/using-azure-management-libraries-from.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>

      <div class="footer-col footer-col-3">
        <p>My very infrequent thoughts on the world of software development</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
