<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Using ASP.Net MVC without a MembershipProvider</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="Most people when they get to securing their ASP.Net MVC applications and managing users look to the MembershipProvider and the RoleProvider – or the new SimpleMembership. For many projects you then quickly realise that they don’t quite do what you want and you end up implementing your own versions of..." /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Using ASP.Net MVC without a MembershipProvider</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2013-03-18T22:22:00+00:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">18 Mar 2013</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#Security" class="icon__txt tag">Security</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> Most people when they get to securing their ASP.Net MVC applications and managing users look to the MembershipProvider and the RoleProvider – or the new SimpleMembership. For many projects you then quickly realise that they don’t <em>quite</em> do what you want and you end up implementing your own versions of the MembershipProvider and the RoleProvider. I have certainly done that myself.<br /><br />A big part of the reason is that, surely, lots of stuff in ASP.Net MVC is tied in to those standard providers and if you want to use nice things like the Authorize attribute then surely you need to use the Providers? As it turns out, this isn’t the case at all. There is a lot less black magic involved and I will claim that there is <em>less</em> work involved if you completely drop the providers compared to implementing your own versions of them. A lot of that has to do with the mental overhead involved in trying to figure out what is going on and figuring out which methods you need to implement.<br /><br />I strongly recommend reading through Brock Allen’s excellent <a href="http://brockallen.com/category/asp-net-security/" target="_blank">blog posts</a> on ASP.Net MVC security in which he also explains why the MembershipProvider and the RoleProvider are poor, leaky and heavyweight abstractions. <br /><br />Firstly, let’s just be clear: You don’t want to write your own logic for storing passwords and you don’t want to write your own logic for handling authentication cookies. ASP.Net MVC has got you covered – those bits are catered for by the framework without you having to use the providers at all.<br /><br />In this post I will demonstrate what actually happens when you use the providers in order to build the understanding and then I will show you a simple example of an app that&nbsp;doesn't&nbsp;use them at all. For this example I am using forms authentication throughout – you know, the one where you type your username and password into a box on a screen and you get a little authentication cookie. <br /><br />In summary, the MembershipProvider is intended as an&nbsp;abstraction&nbsp;for you to manage users and validate their passwords. It is not actually involved in the request processing <em>at all</em> – the Authorize atrribute will not call the MembershipProvider. In the Web Forms days, the MembershipProvider was quite handy because there were built-in controls that knew how to use the providers. But in MVC you have to write all that yourself anyway so the MembershipProvider really doesn’t give you a lot.<br /><br />The RoleProvider on the other hand <em>is</em> used in each request: It is asked to provide the list of roles for a user. Luckily, it is very easy to replace that functionality with your own code as we shall see.<br /><br />FormsAuthentication is the actual important workhorse. That is the one that is responsible for setting the authentication cookie securely, for reading and checking it on each incoming request, for setting HttpContext.Current.User, for managing sliding expiration and much more. <br /><br />If you want to follow along with a full code sample, it is all on GitHub at <a href="https://github.com/flytzen/NoMembershipProviderSample" title="https://github.com/flytzen/NoMembershipProviderSample">https://github.com/flytzen/NoMembershipProviderSample</a>.<br /><em><br /></em> <em>git clone https://github.com/flytzen/NoMembershipProviderSample</em><br /><em><br /></em> <br /><h2>Using FormsAuthentication to log in with no MembershipProvider and no RoleProvider</h2>In this first step, we will show how you can use Forms Authentication to log a user in and use the Authorize attribute without any providers at all. <br /><br /><em>git checkout step-1 </em>if you want to follow along.<br /><br />All you need to enable you to login is this in web.config:<br /><pre class="prettyprint">&lt;system.web&gt;<br />  &lt;authentication mode="Forms"&gt;<br />    &lt;forms loginUrl="~/Home/Login" /&gt;<br />  &lt;/authentication&gt;<br />  ....<br />&lt;/system.web&gt;</pre>This will enable FormsAuthentication and will make ASP.Net look out for a forms authentication cookie on all requests and populate HttpContext.Current.Principal with whatever the cookie says.<br /><br />You need some login logic as well. In our simplified example we don’t use a password so a controller action like this will set the authentication cookie:<br /><pre class="prettyprint">[HttpPost]<br />public ActionResult Login(string userName)<br />{<br />   FormsAuthentication.SetAuthCookie("flytzen", false);<br />   return RedirectToAction("Index");<br />}</pre><br />Of course, you want to do something much smarter than that, such as validating the user – we will get to that. As a side note, you will also be given a returnUrl parameter that you should use to return the user to the URL they were trying to access.<br /><br />Without anything else, you can now use the [Authorize] attribute and the [Authorize(Users = "username")] attribute. For some scenarios, this may be all you need. <br /><br />However, if you try to use [Authorize(Roles = "Administrator")] you will always be redirected to the login screen as you have not done anything to tell ASP.Net what roles this particular user has. For the shortcut on how to handle that, see <a href="http://brockallen.com/2012/05/23/think-twice-about-using-roleprovider/" title="http://brockallen.com/2012/05/23/think-twice-about-using-roleprovider/">http://brockallen.com/2012/05/23/think-twice-about-using-roleprovider/</a><br /><br /><h2>How much does ASP.Net really use MembershipProvider and RoleProvider?</h2>Before we carry on with building our example, let's take a little detour and explore how tightly coupled - or not - ASP.Net MVC is to the providers.<br /><br />One of the challenging things about handling users in ASP.Net MVC is that it is not at all clear how tightly coupled the MembershipProvider and the RoleProvider are into the framework. This means you don’t really know which methods you need to implemented – and it makes it hard to reason about whether to go down that pattern or just roll your own. We will test this out by implementing our own providers and see what is actually called.<br /><br />For the purposes of finding this out, we’ll create a MyMembershipProvider and a MyRoleProvider which inherits from the built-in MembershipProvider and RoleProvider and throws NotImplementedException on every single method.<br /><br /><em>git checkout step-2</em> if you are following along.<br /><br />We need to tell ASP.Net about by inserting the following in Web.config under &lt;system.web&gt;:<br /><pre class="prettyprint">&lt;membership defaultProvider="MyMembershipProvider"&gt;<br />  &lt;providers&gt;<br />    &lt;clear /&gt;<br />    &lt;add name="MyMembershipProvider" type="NoMembershipProviderSample.Providers.MyMembershipProvider" /&gt;<br />  &lt;/providers&gt;<br />&lt;/membership&gt;<br />&lt;roleManager enabled="true" defaultProvider="MyRoleProvider"&gt;<br />  &lt;providers&gt;<br />    &lt;clear /&gt;<br />    &lt;add name="MyRoleProvider" type="NoMembershipProviderSample.Providers.MyRoleProvider" /&gt;<br />  &lt;/providers&gt;<br />&lt;/roleManager&gt;</pre><br />As long as you are not logged in, your app continues to work. However, as soon as you have logged in, you will see that ASP.Net tries to call MyRoleProvider.GetRolesForUser. This happens on every request when you are logged in, irrespective of which URL you access – not only when you hit an action that has [Authorize(Roles=”xxx”)].<br /><br />The only thing you have to do to make everything work again is to change MyRoleProvider like this:<br /><pre class="prettyprint">public override string[] GetRolesForUser(string username)<br />{<br />    return new[] {"Administrator"};<br />}</pre><br /><em>git checkout step-3</em><br /><br />To look at this another way, apart from one single method on RoleProvider, everything that the MembershipProvider and the RoleProvider give you is a means to <em>manage</em> your users and roles and to verify a password on your login screen. This made a lot of sense in the days of Web Forms when you had standard controls that could talk to the Providers. But in MVC you are writing all that yourself anyway. So, I believe it is actually <em>less</em> work to just write the code you need and not bother with the whole provider thing. So that’s what we’ll do next.<br /><br /><h2>Implementing it yourself without using the providers</h2>In this first step we will enable you to create users and validate their passwords.<br /><br /><em>git checkout step-4</em><br /><br />Note that all of this code is rough sample code. For starters it should have error handling and it should certainly all be implemented with dependency injection etc. I am just trying to give you an idea of how simple this fundamentally is here, so forgive the messy code.<br /><br />Storing passwords is dangerous territory and unless you have a degree in cryptography is probably not something you want to do yourself. The good news is that MVC provides a helper method that will generate and validate properly salted password hashes for you. It’s called System.Web.Helpers.Crypto. For a super simple example, I have written the logic into an extension method as seen below. In the real world, you probably want to write a UserManager class and wrap Crypto in an interface so you can dependency inject it and have proper unit tests. Remember, this is just sample code.<br /><pre class="prettyprint">public static class AccountExtensions<br />{<br />     public static void SetPassword(this Account account, string password)<br />     {<br />         account.PasswordHash = Crypto.HashPassword(password);<br />      }<br /><br />    public static bool ValidatePassword(this Account account, string password)<br />    {<br />        return Crypto.VerifyHashedPassword(account.PasswordHash, password);<br />    }<br />}</pre><br />And that is really all there is to it. When I create a new user I just use the SetPassword method to generate a properly salted password. <br /><br />In the login method in the controller you can do something like this:<br /><pre class="prettyprint">[HttpPost]<br />public ActionResult Login(string userName, string password, string returnUrl)<br />{<br />   var repo = new AccountRepository();<br />   var user = repo.FindByName(userName);<br />   if (user != null &amp;&amp; user.ValidatePassword(password))<br />   {<br />      FormsAuthentication.SetAuthCookie(userName, false);<br />      if (returnUrl != null &amp;&amp; Url.IsLocalUrl(returnUrl))<br />         return Redirect(returnUrl);<br />      else<br />         return RedirectToAction("Index");<br />    }<br />    ModelState.AddModelError("", "Invalid user name or password");<br />    return View();<br />}</pre><br />Again, it’s ugly sample code. You would of course want to DI the repository etc. In fact, you would probably want to have a User Manager that could retrieve the user and validate the password etc. But you get the idea.<br /><br />The important thing here is that the two <em>dangerous</em> things, namely storing and validation of passwords and the setting and checking of login-cookies is all handled by ASP.Net for you so you can rely on that team knowing what they are doing. You are only doing the simple and safe things yourself.<br /><br /><h2>So what about roles then?</h2><em>git checkout step-4</em><br /><br />This bit is lifted almost ad verbatim from <a href="http://brockallen.com/2012/05/23/think-twice-about-using-roleprovider/" target="_blank">Brock Allen</a>.<br /><br />In global.asax.cs insert this code:<br /><pre class="prettyprint">void Application_PostAuthenticateRequest(object sender, EventArgs e)<br />{<br />   var ctx = HttpContext.Current;<br />   if (ctx.Request.IsAuthenticated)<br />   {<br />      string[] roles = LookupRolesForUser(ctx.User.Identity.Name);<br />      var newUser = new GenericPrincipal(ctx.User.Identity, roles);<br />      ctx.User = Thread.CurrentPrincipal = newUser;<br />   }<br />}<br /><br />private string[] LookupRolesForUser(string name)<br />{<br />    var repo = new AccountRepository(); // In the real world, you would probably use service locator pattern and call DependencyResolver here<br />    var user = repo.FindByName(name);<br />    if (user != null)<br />    {<br />       return user.Roles;<br />    }<br /><br />    return new string[0];  // Alternatively throw an exception<br />}</pre><br />Note that it may seem wasteful to go and find the roles on each request irrespecitive of whether the Authorize attribute asks for it. That is how the standard RoleProvider implementation works so you are no worse off, at least. But now that you have more control, you could quite easily implement a CurrentUserProvider which has caching so you can save database calls on each request.<br /><br />Alternatively, if you don’t want to mess around with global.asax in this way, you could implement a custom RoleProvider and just implement GetRolesForUser if you really wanted.<br /><br />And there you have it – it really is that simple to not use the Provider model for your users in MVC. Of course, you have to implement things like locking out users, reset password and so on. But as soon as you inherit from the base MembershipProvider you have to provide your own implementation of all those things anyway. And this way you are not bound by the constraints built into the abstraction. </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2013/03/18/using-aspnet-mvc-without.html'; this.page.identifier = '/2013/03/18/using-aspnet-mvc-without.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2013/03/18/using-aspnet-mvc-without.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a href="https://github.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a href="https://www.linkedin.com/in/flytzen/" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2018 </div> </div> </footer> </body> </html>
