<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - Testing Web.Config Transforms with ApprovalTests</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content="In this post I will show how you can write a test with your favourite unit test framework that will apply your web.config transformation and compare the result to a master. ApprovalTests will make it easy to update the master when you make deliberate changes and will alert you when..." />
</head>


  <body>

    <header class="header" role="banner">
  <div class="wrapper">
    
    
    <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="header__nav">
          <a class="header__nav-link" href="/talks">Talks</a>
          <a class="header__nav-link" href="/blog">Blog</a>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Testing Web.Config Transforms with ApprovalTests</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2013-04-07T21:37:00+01:00" itemprop="datePublished">
          
          Apr 7, 2013
        </time>
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#C#">C#</a>
        &nbsp;
        
        <a href="/tags/#Testing">Testing</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    In this post I will show how you can write a test with your favourite unit test framework that will apply your web.config transformation and compare the result to a master. <a href="http://approvaltests.sourceforge.net/" target="_blank">ApprovalTests</a> will make it easy to update the master when you make deliberate changes and will alert you when you make inadvertent changes. <br /><h2>Why would you want to do this?</h2>Normally when you use config transformations you have to use something like <a href="http://visualstudiogallery.msdn.microsoft.com/69023d00-a4f9-4a34-a6cd-7e854ba318b5" target="_blank">SlowCheetah</a> to check the output and it relies on you actually doing this. With this test you have an explicit test that will force you to review the impact of your changes. In my personal scenario, I have a rather complex build script that applies multiple levels of transforms to several config files, including Azure service configs, web.config and app.config files so it becomes quite important to be able to keep track of the impact of any change.<br /><h2>How do we do it?</h2>There are three things we have to do;<br /><ol><li>Get the web.config file into your Unit Test project in the first place  </li><li>Apply the Transform file  </li><li>Compare the output to a master and update the master as required</li></ol>Note that I am using MS Test in this example – you can use NUnit. XUnit and others depending on your preferences.<br /><h2>Get web.config into your unit test project</h2>Your unit tests may run in a predictable directory when you run them through the test runner in Visual Studio. But when you run them through things like <a href="http://www.ncrunch.net/" target="_blank">NCrunch</a>, the tests will actually run in a completely different place. In order to handle this, we will include a <em>link</em> to the web.config files in our unit test project and specify that the file should be copied to the output directory when building.<br /><ol><li>Create a folder for the test in your Unit Test project. In this example we will use “ConfigTest”  </li><li>Right-click on the folder and select “Add” –&gt; “Existing Item”  </li><li>Browse to the Web.Config file in your web project and, on the Add button, select “Add As Link”.  </li><li>Right-click on the linked file in your unit test project and select Properties, then select to Copy to Output Directory.  </li><li>Repeat for the Web.Release.Config file (or whatever transform you are testing)</li></ol><h2>Apply the Transform</h2>In order to apply the Transform, you have to first add the NuGet Package <a href="https://nuget.org/packages/Microsoft.Web.Xdt/" target="_blank">Microsoft.Web.Xdt</a> package. It is pre-release at this time, so use this command:<br /><pre>Install-Package Microsoft.Web.Xdt –pre</pre>This will allow the code-listing below to transform the file and write the output to a string variable.<br /><h2>Compare the result to a master</h2><a href="http://approvaltests.sourceforge.net/" target="_blank">ApprovalTests</a> is quite a different way of doing assertions and I do recommend you check it out. In short and for our purposes, it will show you the result of the transform and, when you are happy with it, will save it as a master. Whenever your result changes, the unit test will start to fail and if you run in interactive mode, you will get the chance to save the result as a new master. See xxx for more details.<br /><br />All we have to do is add the <a href="https://nuget.org/packages/ApprovalTests/" target="_blank">Nuget package</a> for ApprovalTest to our unit test project:<br /><pre>Install-Package ApprovalTests</pre><h2>Finally, the code</h2><pre class="prettyprint">namespace Specs.ConfigTests<br />{<br />    using System.IO;<br />    using System.Reflection;<br />    using System.Xml;<br /><br />    using ApprovalTests;<br />    using ApprovalTests.Reporters;<br /><br />    using Microsoft.VisualStudio.TestTools.UnitTesting;<br />    using Microsoft.Web.XmlTransform;<br /><br />    [TestClass]<br />    [UseReporter(typeof(DiffReporter))]<br />    public class Apptest<br />    {<br />        [TestMethod]<br />        public void Test()<br />        {<br />            // Arrange<br />            var binPath = Assembly.GetExecutingAssembly().Location;<br />            var inputFilePath = Path.Combine(Path.GetDirectoryName(binPath), "ConfigTests\\Web.config");<br />            var transformFilePath = Path.Combine(Path.GetDirectoryName(binPath), "ConfigTests\\Web.Release.config");<br />            string result;<br /><br />            // Act<br />            using (var input = new XmlTransformableDocument())<br />            using (var transformer = new XmlTransformation(transformFilePath))<br />            {<br />                input.Load(inputFilePath);<br />                transformer.Apply(input);<br /><br />                using (var stringWriter = new StringWriter())<br />                using (var xmlWriter = XmlWriter.Create(stringWriter))<br />                {<br />                    input.WriteContentTo(xmlWriter);<br />                    xmlWriter.Flush();<br />                    result = stringWriter.ToString();<br />                }<br />            }<br /><br />            // Assert<br />            Approvals.VerifyXml(result);<br />        }<br />    }<br />}</pre><br />When you run this test interactively, ApprovalTests will fire up whatever diff tool you have installed and you can then save the current version as the new master by “merging” in the diff tool. The details will depend on your diff tool.
  </div>

  
    
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2013/04/07/testing-webconfig-transforms-with.html';
      this.page.identifier = '/2013/04/07/testing-webconfig-transforms-with.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://flytzen.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  

  <a class="u-url" href="/2013/04/07/testing-webconfig-transforms-with.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="footer">

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>
      
    </div>

  </div>

</footer>


  </body>

</html>
