<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - How to Mock RestSharp.ExecuteAsync</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content="It took me a while to figure out how to Mock RestSharp’s ExecuteAsync method for unit testing purposes. Once you realise that ExecuteAsync takes a callback which is called when the REST call completes it all becomes reasonably straightforward, using Mocks Callback function;Mock&lt;IRestClient&gt; restClient = new Mock&lt;IRestClient&gt;(); restClient.Setup(c =&gt; c.ExecuteAsync&lt;MyResult&gt;(..." />
</head>


  <body>

    <header class="header" role="banner">
  <div class="wrapper">
    
    
    <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="header__nav">
          <a class="header__nav-link" href="/talks">Talks</a>
          <a class="header__nav-link" href="/blog">Blog</a>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to Mock RestSharp.ExecuteAsync</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2013-01-10T20:35:00+00:00" itemprop="datePublished">
          
          Jan 10, 2013
        </time>
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#Testing">Testing</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    It took me a while to figure out how to Mock RestSharp’s ExecuteAsync method for unit testing purposes. Once you realise that ExecuteAsync takes a callback which is called when the REST call completes it all becomes reasonably straightforward, using Mocks Callback function;<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:33beae74-eabd-4126-a56d-8c29a9058179" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="prettyprint">Mock&lt;IRestClient&gt; restClient = new Mock&lt;IRestClient&gt;();<br />            restClient.Setup(c =&gt; c.ExecuteAsync&lt;MyResult&gt;(<br />                    Moq.It.IsAny&lt;IRestRequest&gt;(), <br />                    Moq.It.IsAny&lt;Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;()))<br />                .Callback&lt;IRestRequest, Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;((request, callback) =&gt;<br />                {<br />                    var responseMock = new Mock&lt;IRestResponse&lt;MyResult&gt;&gt;();<br />                    responseMock.Setup(r =&gt; r.Data).Returns(new MyResult() { Foo = "Bar" });<br />                    callback(responseMock.Object, null);<br />                });</pre></div><br />In my scenario I wanted to use the built-deserialization and return a “MyResult".<br />This means that ExecuteAsync takes two parameters:<br /><ul><li>An IRestRequest </li><li>A callback, which is an Action&lt;IRestResponse&lt;AuthorisationResponse&gt;, RestRequestAsyncHandle&gt; <br /><br />That is just the callback you pass in and it is a delegate that takes two parameters, namely the IRestResponse and a RestRequestAsyncHandle. </li></ul>When you are running this for real, RestSharp will execute your IRestRequest and then call your callback with the result. So in our Unit test, we can use Mock’s Callback feature to call your callback straight away. To your code that will just look like the website responded really quickly.<br /><br />When I actually call the callback function, I also use Mock to mock the IRestResponse and just configure that mock to return a concrete instance of MyResult. <br /><br /><h2>EDIT 9 November 2013</h2>A fuller example:<br /><br /><pre class="prettyprint">public class Sud<br />{<br />    private IRestClient client;<br /><br />    public Sud(IRestClient client)<br />    {<br />        this.client = client;<br />    }<br /><br />    public MyResult Foo()<br />    {<br />        // NOTE: This code is obviously stupid; it just blocks the thread until the async task completes, which is rather pointless.<br />        // It's just an example :)<br />        MyResult result = null;<br />        var request = new RestRequest();<br />        var blocker = new AutoResetEvent(false);<br /><br />        this.client.ExecuteAsync&lt;MyResult&gt;(<br />            request, <br />            response =&gt;<br />            {<br />                result = response.Data;<br />                blocker.Set();<br />            });<br />        blocker.WaitOne();<br />        return result;<br />    }<br />}<br /><br />public class MyResult<br />{<br />    public string Name { get; set; }<br />}<br /><br />[TestFixture]<br />public class Tests<br />{<br />    [Test]<br />    public void TestFoo()<br />    {<br />        Mock&lt;IRestClient&gt; restClient = new Mock&lt;IRestClient&gt;();<br />        restClient.Setup(c =&gt; c.ExecuteAsync&lt;MyResult&gt;(<br />                Moq.It.IsAny&lt;IRestRequest&gt;(),<br />                Moq.It.IsAny&lt;Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;()))<br />            .Callback&lt;IRestRequest, Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;((request, callback) =&gt;<br />            {<br />                var responseMock = new Mock&lt;IRestResponse&lt;MyResult&gt;&gt;();<br />                responseMock.Setup(r =&gt; r.Data).Returns(new MyResult() { Name = &quot;Billy Bob&quot; });<br />                callback(responseMock.Object, null);<br />            });<br /><br />        var Subject = new Sud(restClient.Object);<br /><br />        var result = Subject.Foo();<br /><br />        Assert.IsNotNull(result);<br />        Assert.AreEqual(&quot;Billy Bob&quot;, result.Name);<br />    }<br />}<br /></pre>
  </div>

  
    
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2013/01/10/how-to-mock-restsharpexecuteasync.html';
      this.page.identifier = '/2013/01/10/how-to-mock-restsharpexecuteasync.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://flytzen.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  

  <a class="u-url" href="/2013/01/10/how-to-mock-restsharpexecuteasync.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="footer">

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>
      
    </div>

  </div>

</footer>


  </body>

</html>
