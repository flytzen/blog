<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Continuous deployment to Azure Cloud Services</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="When you use Azure Websites you can do continuous deployment using Git, but with cloud services you can only do it from TFS. Luckily, it is quite easy to set up a Powershell script to deploy to Cloud Services. In this post I will share a sample script that can..." /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Continuous deployment to Azure Cloud Services</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2013-08-15T20:59:00+01:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">15 Aug 2013</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#Azure" class="icon__txt tag">Azure</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> When you use Azure Websites you can do continuous deployment using Git, but with cloud services you can only do it from TFS. Luckily, it is quite easy to set up a Powershell script to deploy to Cloud Services. In this post I will share a sample script that can be used to deploy to multiple different environments, such as a UAT and a Live environment. I am assuming that you have set up corresponding UAT and Live Build and Azure profiles. The reason for this is that you can then easily use Web.Config transformation to change settings between UAT and Live and also use the two different Azure configurations to have different Azure settings. If you need to do an app.config transformation for your worker as part of your deploy, have a look at this <a href="http://stackoverflow.com/questions/13828065/azure-worker-role-config-file-transformations/14413859#14413859">Stackoverflow answer</a>.<br />We are using this script to deploy manually as well as deploying automatically from our TeamCity server.<br /><h2>Pre-requisites</h2><ul><li>Before you start you need to <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg551722.aspx">create a Management Certificate</a> for your Azure subscription, import it on your machine and add the thumb print to the script.</li><li>You will also need to install the Azure Powershell CmdLets on your machine (it’s usually installed as part of the SDK). When you look at the script, there are a couple of values you will need to provide.</li><li>Put the script and the configuration XML file in a folder in your solution called Deployment.</li><li>Assuming you want to enable remote access to your servers, you need to create a certificate and put it in the Deployment folder next to the script. You can do this by using Visual Studio to do a deployment first and enable remote access; This will configure the config files with the thumbprint and will generate a certificate for you. If you don’t want remote access, just remove that bit of the script.</li></ul><pre class="prettyprint">Param(<br />   [string]$deploymentType,<br />   [string]$deployToAzure,<br />   [string]$slot<br />)<br /><br />$managementCertificateThumbprint="[YOURMANAGEMENTCERTIFICATETHUMBPRINT]"<br /><br />function Build()<br />{<br />    $dotNetVersion = "4.0"<br />    $regKey = "HKLM:\software\Microsoft\MSBuild\ToolsVersions\$dotNetVersion"<br />    $regProperty = "MSBuildToolsPath"<br />    $msbuildExe = join-path -path (Get-ItemProperty $regKey).$regProperty -childpath "msbuild.exe"<br />    <br />    Write-Host "Building..." -ForegroundColor Yellow<br />    &amp;$msbuildExe [YOURSOLUTIONNAME].sln /t:Publish /p:TargetProfile=$deploymentType /p:Configuration=$deploymentType /p:Platform="Any CPU" <br /><br />    if ($LASTEXITCODE -ne 0)<br />    {<br />        throw "The build failed"<br />    }<br />}<br /><br />function Deploy()<br />{<br />    Import-Module Azure<br />    write-host "`nAzure CmdLets loaded" -ForegroundColor Green<br />    $configFile = $configFolder + "\AzureSettings.xml"<br />    if (! (Test-Path $configFile))<br />    {<br />        Throw ("Unable to find " + $configFile)<br />    }<br />    [xml]$azureSettings = Get-Content ($configFile)<br />    $subscriptionId = $azureSettings.AzureSettings.SubscriptionID<br />    $friendlySubName = $azureSettings.AzureSettings.FriendlySubName<br />    $serviceSettings = ($azureSettings.AzureSettings.Services.Service | Where-Object {$_.deploymentType -match $deploymentType })<br />    $serviceName = $serviceSettings.ServiceName<br />    $storageAccount = $serviceSettings.DeploymentStorageAccount<br /><br />    if (Test-Path cert:\CurrentUser\My\$managementCertificateThumbprint)<br />    {<br />        $myCert = Get-Item cert:\CurrentUser\My\$managementCertificateThumbprint<br />    }<br />    else {<br />        if (Test-Path cert:\LocalMachine\My\$managementCertificateThumbprint) {<br />            $myCert = Get-Item cert:\LocalMachine\My\$managementCertificateThumbprint<br />        }<br />        else {<br />            Throw ("Unable to find the management certificate in either current user or local machine storage")<br />        }<br />    }<br />    Write-Host ("Adding " + $friendlySubName + " subscription") -ForegroundColor Green<br />    Set-AzureSubscription -SubscriptionName $friendlySubName -Certificate $myCert -SubscriptionID $subscriptionId<br /><br />    Select-AzureSubscription $friendlySubName<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot -ErrorVariable a -ErrorAction silentlycontinue<br />    $deploymentLabel = $deploymentType + " " + $(Get-Date –f $timeStampFormat)<br /><br />    Set-AzureSubscription -SubscriptionName $friendlySubName -CurrentStorageAccount $storageAccount<br /><br />    #Make sure we have the remote access certificate in there<br />    Add-AzureCertificate -ServiceName $serviceName -CertToDeploy ($configFolder + "\RemoteAccessCertificate.pfx") -Password powershellSucks<br /><br /> Write-Host ("About to deploy " + $deploymentType + " " + $service + " to " + $slot + " in " + $location) -ForegroundColor Green<br /> Write-Host ("Subscription: " + $friendlySubName + ", Service: " + $serviceName + ", Storage: " + $storageAccount) -ForegroundColor Green<br /><br />    if ($a[0] -ne $null)<br />    {<br />        #Write-Host "No current deployment, creating a new deployment"<br />        CreateNewDeployment<br />    }<br />    else<br />    {<br />        Write-Host "Existing deployment, upgrading..."<br />        UpgradeDeployment<br />    }<br />}<br /><br />function CreateNewDeployment()<br />{<br />    write-progress -id 3 -activity "Creating New Deployment" -Status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Creating New Deployment: In progress"<br /><br />    $opstat = New-AzureDeployment -Slot $slot -Package $packageLocation -Configuration $cloudConfigLocation -label $deploymentLabel -ServiceName $serviceName<br /><br />    $completeDeployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $completeDeploymentID = $completeDeployment.deploymentid<br /><br />    write-progress -id 3 -activity "Creating New Deployment" -completed -Status "Complete"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Creating New Deployment: Complete, Deployment ID: $completeDeploymentID"<br /><br />    StartInstances<br />}<br /><br />function UpgradeDeployment()<br />{<br />    write-progress -id 3 -activity "Upgrading Deployment" -Status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Upgrading Deployment: In progress"<br /><br />    # perform Update-Deployment<br />    $setdeployment = Set-AzureDeployment -Upgrade -Slot $slot -Package $packageLocation -Configuration $cloudConfigLocation -label $deploymentLabel -ServiceName $serviceName -Force<br /><br />    $completeDeployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $completeDeploymentID = $completeDeployment.deploymentid<br /><br />    write-progress -id 3 -activity "Upgrading Deployment" -completed -Status "Complete"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Upgrading Deployment: Complete, Deployment ID: $completeDeploymentID"<br />}<br /><br />function StartInstances()<br />{<br />    write-progress -id 4 -activity "Starting Instances" -status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instances: In progress"<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $runstatus = $deployment.Status<br /><br />    if ($runstatus -ne 'Running') <br />    {<br />        $run = Set-AzureDeployment -Slot $slot -ServiceName $serviceName -Status Running<br />    }<br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $oldStatusStr = @("") * $deployment.RoleInstanceList.Count<br /><br />    while (-not(AllInstancesRunning($deployment.RoleInstanceList)))<br />    {<br />        $i = 1<br />        foreach ($roleInstance in $deployment.RoleInstanceList)<br />        {<br />            $instanceName = $roleInstance.InstanceName<br />            $instanceStatus = $roleInstance.InstanceStatus<br /><br />            if ($oldStatusStr[$i - 1] -ne $roleInstance.InstanceStatus)<br />            {<br />                $oldStatusStr[$i - 1] = $roleInstance.InstanceStatus<br />                Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instance '$instanceName': $instanceStatus"<br />            }<br /><br />            write-progress -id (4 + $i) -activity "Starting Instance '$instanceName'" -status "$instanceStatus"<br />            $i = $i + 1<br />        }<br /><br />        sleep -Seconds 1<br /><br />        $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    }<br /><br />    $i = 1<br />    foreach ($roleInstance in $deployment.RoleInstanceList)<br />    {<br />        $instanceName = $roleInstance.InstanceName<br />        $instanceStatus = $roleInstance.InstanceStatus<br /><br />        if ($oldStatusStr[$i - 1] -ne $roleInstance.InstanceStatus)<br />        {<br />            $oldStatusStr[$i - 1] = $roleInstance.InstanceStatus<br />            Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instance '$instanceName': $instanceStatus"<br />        }<br /><br />        $i = $i + 1<br />    }<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $opstat = $deployment.Status <br /><br />    write-progress -id 4 -activity "Starting Instances" -completed -status $opstat<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instances: $opstat"<br />}<br /><br />function AllInstancesRunning($roleInstanceList)<br />{<br />    foreach ($roleInstance in $roleInstanceList)<br />    {<br />        if ($roleInstance.InstanceStatus -ne "ReadyRole")<br />        {<br />            return $false<br />        }<br />    }<br /><br />    return $true<br />}<br /><br />#Get to the right place...<br />$scriptPath = $MyInvocation.MyCommand.Path<br />$dir = Split-Path $scriptPath<br />cd $dir<br />cd..<br /><br />$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")<br />if (!$isAdmin)<br />{<br />    throw "You need to run this script as an admin"<br />}<br /><br />$configFolder = "Deployment"<br />if (!(Test-Path $configFolder))<br />{<br />    Throw ("There is no '" + $configFolder + "' folder. Aborting.")<br />}<br /><br />while ((!$deploymentType) -OR ($deploymentType -notin ("Live", "UAT", "Dev" )))<br />{<br />    $deploymentType = Read-Host "Please specify deployment type Live or UAT (or Dev)"<br />}<br /><br />while ((!$slot) -or ($slot -notin ("Production", "Staging")))<br />{<br />    $slot = Read-Host "Deploy to Production or Staging?"<br />}<br /><br />Build<br /><br />while ((!$deployToAzure ) -or ($deployToAzure -notin ("Y", "N")))<br />{<br />    $deployToAzure = Read-Host "Do you want to actually deploy this to Azure now (Y/N)?"<br />}<br /><br />if ($deployToAzure -eq "Y")<br />{<br />    $packageLocation = $dir + "\..\Cloud\bin\" + $deploymentType + "\app.publish\Cloud.cspkg"<br />    $cloudConfigLocation = $dir + "\..\Cloud\bin\" + $deploymentType + "\app.publish\ServiceConfiguration." + $deploymentType + ".cscfg"<br />    Deploy<br />}<br /></pre><br />Note that some of the above scripts have been found elsewhere on the internet, in particular the functions to actuall create/upgrade deployments.<br /><br />You will also need a configuration file to hold some information about each of your environments:<br /><pre class="prettyprint">&lt;azuresettings&gt;<br />  &lt;subscriptionid&gt;[SUBSCRIPTIONID]&lt;/subscriptionid&gt;<br />  &lt;friendlysubname&gt;[WHATEVERYOUWANT]&lt;/friendlysubname&gt;<br />    &lt;services&gt;<br />      &lt;service deploymenttype="UAT"&gt;<br />        &lt;servicename&gt;[CLOUDSERVICENAME eg myuatcloudservice]&lt;/servicename&gt;<br />        &lt;deploymentstorageaccount&gt;[STORAGEACCOUNTNAME eg myuatstorage]&lt;/deploymentstorageaccount&gt;<br />      &lt;/service&gt;<br />    &lt;/services&gt;<br />  &lt;services&gt;<br />    &lt;service deploymenttype="Live"&gt;<br />      &lt;servicename&gt;[CLOUDSERVICENAME eg myuatcloudservice]&lt;/servicename&gt;<br />      &lt;deploymentstorageaccount&gt;[STORAGEACCOUNTNAME eg myuatstorage]&lt;/deploymentstorageaccount&gt;<br />    &lt;/service&gt;<br />  &lt;/services&gt;<br />&lt;/azuresettings&gt;</pre></div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2013/08/15/continuous-deployment-to-azure-cloud.html'; this.page.identifier = '/2013/08/15/continuous-deployment-to-azure-cloud.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2013/08/15/continuous-deployment-to-azure-cloud.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a rel="me" href="https://github.com/flytzen" target="_blank" alt="GitHub"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a rel="me" href="https://www.linkedin.com/in/flytzen/" target="_blank" alt="LinkedIn"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a rel="me" href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon" alt="Twitter"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> <a rel="me" href="https://hachyderm.io/@flytzen" target="_blank"> <svg style="width:24px;height:24px" fill="currentColor" viewBox="0 0 24 24" class="social-icon" alt="Mastodon"> <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2022 </div> </div> </footer> </body> </html>
