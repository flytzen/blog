<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - Continuous deployment to Azure Cloud Services</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content="When you use Azure Websites you can do continuous deployment using Git, but with cloud services you can only do it from TFS. Luckily, it is quite easy to set up a Powershell script to deploy to Cloud Services. In this post I will share a sample script that can..." />
</head>


  <body>

    <header class="site-header" role="banner">
  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/talks">Talks</a>
          <a class="page-link" href="/blog">Blog</a>
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Continuous deployment to Azure Cloud Services</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2013-08-15T20:59:00+01:00" itemprop="datePublished">
          
          Aug 15, 2013
        </time>
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#Azure">Azure</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    When you use Azure Websites you can do continuous deployment using Git, but with cloud services you can only do it from TFS. Luckily, it is quite easy to set up a Powershell script to deploy to Cloud Services. In this post I will share a sample script that can be used to deploy to multiple different environments, such as a UAT and a Live environment. I am assuming that you have set up corresponding UAT and Live Build and Azure profiles. The reason for this is that you can then easily use Web.Config transformation to change settings between UAT and Live and also use the two different Azure configurations to have different Azure settings. If you need to do an app.config transformation for your worker as part of your deploy, have a look at this <a href="http://stackoverflow.com/questions/13828065/azure-worker-role-config-file-transformations/14413859#14413859">Stackoverflow answer</a>.<br />We are using this script to deploy manually as well as deploying automatically from our TeamCity server.<br /><h2>Pre-requisites</h2><ul><li>Before you start you need to <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg551722.aspx">create a Management Certificate</a> for your Azure subscription, import it on your machine and add the thumb print to the script.</li><li>You will also need to install the Azure Powershell CmdLets on your machine (it’s usually installed as part of the SDK). When you look at the script, there are a couple of values you will need to provide.</li><li>Put the script and the configuration XML file in a folder in your solution called Deployment.</li><li>Assuming you want to enable remote access to your servers, you need to create a certificate and put it in the Deployment folder next to the script. You can do this by using Visual Studio to do a deployment first and enable remote access; This will configure the config files with the thumbprint and will generate a certificate for you. If you don’t want remote access, just remove that bit of the script.</li></ul><pre class="prettyprint">Param(<br />   [string]$deploymentType,<br />   [string]$deployToAzure,<br />   [string]$slot<br />)<br /><br />$managementCertificateThumbprint="[YOURMANAGEMENTCERTIFICATETHUMBPRINT]"<br /><br />function Build()<br />{<br />    $dotNetVersion = "4.0"<br />    $regKey = "HKLM:\software\Microsoft\MSBuild\ToolsVersions\$dotNetVersion"<br />    $regProperty = "MSBuildToolsPath"<br />    $msbuildExe = join-path -path (Get-ItemProperty $regKey).$regProperty -childpath "msbuild.exe"<br />    <br />    Write-Host "Building..." -ForegroundColor Yellow<br />    &amp;$msbuildExe [YOURSOLUTIONNAME].sln /t:Publish /p:TargetProfile=$deploymentType /p:Configuration=$deploymentType /p:Platform="Any CPU" <br /><br />    if ($LASTEXITCODE -ne 0)<br />    {<br />        throw "The build failed"<br />    }<br />}<br /><br />function Deploy()<br />{<br />    Import-Module Azure<br />    write-host "`nAzure CmdLets loaded" -ForegroundColor Green<br />    $configFile = $configFolder + "\AzureSettings.xml"<br />    if (! (Test-Path $configFile))<br />    {<br />        Throw ("Unable to find " + $configFile)<br />    }<br />    [xml]$azureSettings = Get-Content ($configFile)<br />    $subscriptionId = $azureSettings.AzureSettings.SubscriptionID<br />    $friendlySubName = $azureSettings.AzureSettings.FriendlySubName<br />    $serviceSettings = ($azureSettings.AzureSettings.Services.Service | Where-Object {$_.deploymentType -match $deploymentType })<br />    $serviceName = $serviceSettings.ServiceName<br />    $storageAccount = $serviceSettings.DeploymentStorageAccount<br /><br />    if (Test-Path cert:\CurrentUser\My\$managementCertificateThumbprint)<br />    {<br />        $myCert = Get-Item cert:\CurrentUser\My\$managementCertificateThumbprint<br />    }<br />    else {<br />        if (Test-Path cert:\LocalMachine\My\$managementCertificateThumbprint) {<br />            $myCert = Get-Item cert:\LocalMachine\My\$managementCertificateThumbprint<br />        }<br />        else {<br />            Throw ("Unable to find the management certificate in either current user or local machine storage")<br />        }<br />    }<br />    Write-Host ("Adding " + $friendlySubName + " subscription") -ForegroundColor Green<br />    Set-AzureSubscription -SubscriptionName $friendlySubName -Certificate $myCert -SubscriptionID $subscriptionId<br /><br />    Select-AzureSubscription $friendlySubName<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot -ErrorVariable a -ErrorAction silentlycontinue<br />    $deploymentLabel = $deploymentType + " " + $(Get-Date –f $timeStampFormat)<br /><br />    Set-AzureSubscription -SubscriptionName $friendlySubName -CurrentStorageAccount $storageAccount<br /><br />    #Make sure we have the remote access certificate in there<br />    Add-AzureCertificate -ServiceName $serviceName -CertToDeploy ($configFolder + "\RemoteAccessCertificate.pfx") -Password powershellSucks<br /><br /> Write-Host ("About to deploy " + $deploymentType + " " + $service + " to " + $slot + " in " + $location) -ForegroundColor Green<br /> Write-Host ("Subscription: " + $friendlySubName + ", Service: " + $serviceName + ", Storage: " + $storageAccount) -ForegroundColor Green<br /><br />    if ($a[0] -ne $null)<br />    {<br />        #Write-Host "No current deployment, creating a new deployment"<br />        CreateNewDeployment<br />    }<br />    else<br />    {<br />        Write-Host "Existing deployment, upgrading..."<br />        UpgradeDeployment<br />    }<br />}<br /><br />function CreateNewDeployment()<br />{<br />    write-progress -id 3 -activity "Creating New Deployment" -Status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Creating New Deployment: In progress"<br /><br />    $opstat = New-AzureDeployment -Slot $slot -Package $packageLocation -Configuration $cloudConfigLocation -label $deploymentLabel -ServiceName $serviceName<br /><br />    $completeDeployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $completeDeploymentID = $completeDeployment.deploymentid<br /><br />    write-progress -id 3 -activity "Creating New Deployment" -completed -Status "Complete"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Creating New Deployment: Complete, Deployment ID: $completeDeploymentID"<br /><br />    StartInstances<br />}<br /><br />function UpgradeDeployment()<br />{<br />    write-progress -id 3 -activity "Upgrading Deployment" -Status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Upgrading Deployment: In progress"<br /><br />    # perform Update-Deployment<br />    $setdeployment = Set-AzureDeployment -Upgrade -Slot $slot -Package $packageLocation -Configuration $cloudConfigLocation -label $deploymentLabel -ServiceName $serviceName -Force<br /><br />    $completeDeployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $completeDeploymentID = $completeDeployment.deploymentid<br /><br />    write-progress -id 3 -activity "Upgrading Deployment" -completed -Status "Complete"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Upgrading Deployment: Complete, Deployment ID: $completeDeploymentID"<br />}<br /><br />function StartInstances()<br />{<br />    write-progress -id 4 -activity "Starting Instances" -status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instances: In progress"<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $runstatus = $deployment.Status<br /><br />    if ($runstatus -ne 'Running') <br />    {<br />        $run = Set-AzureDeployment -Slot $slot -ServiceName $serviceName -Status Running<br />    }<br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $oldStatusStr = @("") * $deployment.RoleInstanceList.Count<br /><br />    while (-not(AllInstancesRunning($deployment.RoleInstanceList)))<br />    {<br />        $i = 1<br />        foreach ($roleInstance in $deployment.RoleInstanceList)<br />        {<br />            $instanceName = $roleInstance.InstanceName<br />            $instanceStatus = $roleInstance.InstanceStatus<br /><br />            if ($oldStatusStr[$i - 1] -ne $roleInstance.InstanceStatus)<br />            {<br />                $oldStatusStr[$i - 1] = $roleInstance.InstanceStatus<br />                Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instance '$instanceName': $instanceStatus"<br />            }<br /><br />            write-progress -id (4 + $i) -activity "Starting Instance '$instanceName'" -status "$instanceStatus"<br />            $i = $i + 1<br />        }<br /><br />        sleep -Seconds 1<br /><br />        $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    }<br /><br />    $i = 1<br />    foreach ($roleInstance in $deployment.RoleInstanceList)<br />    {<br />        $instanceName = $roleInstance.InstanceName<br />        $instanceStatus = $roleInstance.InstanceStatus<br /><br />        if ($oldStatusStr[$i - 1] -ne $roleInstance.InstanceStatus)<br />        {<br />            $oldStatusStr[$i - 1] = $roleInstance.InstanceStatus<br />            Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instance '$instanceName': $instanceStatus"<br />        }<br /><br />        $i = $i + 1<br />    }<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $opstat = $deployment.Status <br /><br />    write-progress -id 4 -activity "Starting Instances" -completed -status $opstat<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instances: $opstat"<br />}<br /><br />function AllInstancesRunning($roleInstanceList)<br />{<br />    foreach ($roleInstance in $roleInstanceList)<br />    {<br />        if ($roleInstance.InstanceStatus -ne "ReadyRole")<br />        {<br />            return $false<br />        }<br />    }<br /><br />    return $true<br />}<br /><br />#Get to the right place...<br />$scriptPath = $MyInvocation.MyCommand.Path<br />$dir = Split-Path $scriptPath<br />cd $dir<br />cd..<br /><br />$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")<br />if (!$isAdmin)<br />{<br />    throw "You need to run this script as an admin"<br />}<br /><br />$configFolder = "Deployment"<br />if (!(Test-Path $configFolder))<br />{<br />    Throw ("There is no '" + $configFolder + "' folder. Aborting.")<br />}<br /><br />while ((!$deploymentType) -OR ($deploymentType -notin ("Live", "UAT", "Dev" )))<br />{<br />    $deploymentType = Read-Host "Please specify deployment type Live or UAT (or Dev)"<br />}<br /><br />while ((!$slot) -or ($slot -notin ("Production", "Staging")))<br />{<br />    $slot = Read-Host "Deploy to Production or Staging?"<br />}<br /><br />Build<br /><br />while ((!$deployToAzure ) -or ($deployToAzure -notin ("Y", "N")))<br />{<br />    $deployToAzure = Read-Host "Do you want to actually deploy this to Azure now (Y/N)?"<br />}<br /><br />if ($deployToAzure -eq "Y")<br />{<br />    $packageLocation = $dir + "\..\Cloud\bin\" + $deploymentType + "\app.publish\Cloud.cspkg"<br />    $cloudConfigLocation = $dir + "\..\Cloud\bin\" + $deploymentType + "\app.publish\ServiceConfiguration." + $deploymentType + ".cscfg"<br />    Deploy<br />}<br /></pre><br />Note that some of the above scripts have been found elsewhere on the internet, in particular the functions to actuall create/upgrade deployments.<br /><br />You will also need a configuration file to hold some information about each of your environments:<br /><pre class="prettyprint">&lt;azuresettings&gt;<br />  &lt;subscriptionid&gt;[SUBSCRIPTIONID]&lt;/subscriptionid&gt;<br />  &lt;friendlysubname&gt;[WHATEVERYOUWANT]&lt;/friendlysubname&gt;<br />    &lt;services&gt;<br />      &lt;service deploymenttype="UAT"&gt;<br />        &lt;servicename&gt;[CLOUDSERVICENAME eg myuatcloudservice]&lt;/servicename&gt;<br />        &lt;deploymentstorageaccount&gt;[STORAGEACCOUNTNAME eg myuatstorage]&lt;/deploymentstorageaccount&gt;<br />      &lt;/service&gt;<br />    &lt;/services&gt;<br />  &lt;services&gt;<br />    &lt;service deploymenttype="Live"&gt;<br />      &lt;servicename&gt;[CLOUDSERVICENAME eg myuatcloudservice]&lt;/servicename&gt;<br />      &lt;deploymentstorageaccount&gt;[STORAGEACCOUNTNAME eg myuatstorage]&lt;/deploymentstorageaccount&gt;<br />    &lt;/service&gt;<br />  &lt;/services&gt;<br />&lt;/azuresettings&gt;</pre>
  </div>

  
    

  

  <a class="u-url" href="/2013/08/15/continuous-deployment-to-azure-cloud.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>

      <div class="footer-col footer-col-3">
        <p>My very infrequent thoughts on the world of software development</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
