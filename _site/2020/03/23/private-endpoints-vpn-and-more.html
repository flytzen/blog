<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Azure Private End Points, VPNs and multi-site</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="Azure Private End Points, VPN clients and multi-region setups." /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Azure Private End Points, VPNs and multi-site</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2020-03-23T00:00:00+00:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">23 Mar 2020</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#Azure" class="icon__txt tag">Azure</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> <p><em>NOTE: Right now this is not a finished post - I haven’t yet figured out how to make this work. I have written it up here partially to be able to raise a support query.</em></p> <h1 id="this-is-what-i-am-trying-to-achieve">This is what I am trying to achieve</h1> <div style="width: 640px; height: 480px; margin: 10px; position: relative;"><iframe allowfullscreen="" frameborder="0" style="width:640px; height:480px" src="https://www.lucidchart.com/documents/embeddedchart/41848683-692d-4268-bc3f-e4d9ab764098" id="Pt~IQN7FkdqC"></iframe></div> <p>I have a database in the Europe North and another one in Australia East. I have users in both geographies and they need to be able to access both databases in order to write PowerBI reports. Ideally I want the users in both locations to be able to connect to a local VPN Gateway to avoid unnecessary roundtrips; at the distances we are talking about, latency becomes a real issue.</p> <p>Until fairly recently the only way to do this was to open up the user’s IP address on the SQL Firewall. Fortunately, with the advent of Private Link / Private Endpoint, you can now connect to Azure SQL via a VPN client.</p> <p>The complication is that that a virtual network cannot span multiple data centres, so you have to connect them using either “virtual network peering” or “virtual network gateway connections”. I have tried both and they come with different trade-offs.</p> <h1 id="peering">Peering</h1> <p>Virtual networks can be <em>peered</em>. The setup here is based on <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-peering-gateway-transit">this article</a>.</p> <div style="width: 640px; height: 480px; margin: 10px; position: relative;"><iframe allowfullscreen="" frameborder="0" style="width:640px; height:480px" src="https://www.lucidchart.com/documents/embeddedchart/2eb8492a-7b8b-4410-a4f8-9b386194dabc" id="vC~I0fkY7VUW"></iframe></div> <p>In this setup, I have created two peerings:</p> <ul> <li>One going from Europe to Australia which has “Allow Gateway Transit” set.</li> <li>One going from Australia to Europe which has “Use Remote Gateways” set.</li> </ul> <h2 id="what-works">What works</h2> <p>I can connect to the Europe Gateway and connect to the database in both locations. That is a success.</p> <p>When I connect to the Azure VPN client, I can see in the <code class="highlighter-rouge">AzureVpnCxn.log</code> that I get both the 10.0.0.0/16 and the 10.1.0.0/16 routes.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Received option: route 10.0.0.0 255.255.0.0
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Assigned Route: 10.0.0.0 / 255.255.0.0
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Received option: route 10.1.0.0 255.255.0.0
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Assigned Route: 10.1.0.0 / 255.255.0.0
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Received option: route-gateway 172.16.10.1
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Received option: topology subnet
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Received option: ifconfig 172.16.10.2 255.255.255.128
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Assigned IP address: 172.16.10.2 / 255.255.255.128
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Assigned Route: 172.16.10.0 / 255.255.255.128
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00024864] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Received option: cipher AES-256-GCM
[‎3‎/‎23‎/‎2020‎ ‎1‎:‎28‎:‎14‎ ‎PM] PId:[00025864] TId:[00010832] [momenta-live-eun] [{cd712a18-c0d7-482c-9f11-7404ad0c7b1b}] [Verbose] Session established!
</code></pre></div></div> <h2 id="what-doesnt-work">What doesn’t work</h2> <p>This setup is designed for a “hub and spoke” architecture; Setting the “Use Remote Gateways” setting explicitly disallows me from having a Gateway in Australia. In other words, my Australia users have to connect to the VPN Gateway in Europe, which means they’ll suffer double latency when querying the Australia database.<br /> If you don’t set the “Use Remote Gateways” options, you won’t get the 10.1.0.0/16 route when you connect with the Azure VPN Client.</p> <h1 id="gateway-connection">Gateway Connection</h1> <p>In this setup, you use Gateway Connections between the two networks.</p> <div style="width: 640px; height: 480px; margin: 10px; position: relative;"><iframe allowfullscreen="" frameborder="0" style="width:640px; height:480px" src="https://www.lucidchart.com/documents/embeddedchart/54b1279f-d5f1-4513-9e5b-a8346ab78cc6" id="QD~Ipb0I~VxK"></iframe></div> <h2 id="what-works-1">What works</h2> <p>I get the routes served to me, from the <code class="highlighter-rouge">AzureVpnCxn.log</code> I get this:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Received option: route 10.0.0.0 255.255.0.0
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Assigned Route: 10.0.0.0 / 255.255.0.0
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Received option: route 10.1.0.0 255.255.0.0
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Assigned Route: 10.1.0.0 / 255.255.0.0
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Received option: route-gateway 172.16.10.1
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Received option: topology subnet
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Received option: ifconfig 172.16.10.3 255.255.255.128
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Assigned IP address: 172.16.10.3 / 255.255.255.128
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Assigned Route: 172.16.10.0 / 255.255.255.128
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00018256] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Received option: cipher AES-256-GCM
[‎3‎/‎20‎/‎2020‎ ‎4‎:‎51‎:‎21‎ ‎PM] PId:[00011592] TId:[00012216] [momenta-live-eun] [{7412cb8b-e91a-4757-8f1f-c32c4406248e}] [Verbose] Session established!
</code></pre></div></div> <p><strong>This is exactly the same as when I used peerings</strong></p> <h2 id="what-doesnt-work-1">What doesn’t work</h2> <p>When I connect to the Europe Gateway, I am <em>not</em> able to connect to the Australia database; the connection simply times out. I suspect that the remote network is unable to respond, because:</p> <ul> <li>The Europe -&gt; Australia Gateway connection shows that it has data going <em>out</em> but 0 bytes data <em>in</em>.</li> <li>The Australia -&gt; Europe Gateway connection shows that it has data coming <em>in</em> but 0 bytes data <em>out</em>.</li> </ul> <h2 id="notes">Notes</h2> <ul> <li>I don’t know why you have to create two connections, one for each direction.</li> <li>You can enable <code class="highlighter-rouge">Border Gateway Protocol</code> (BGP) on the gateways. Interestingly, if you do that, you <em>don’t</em> get the route for the remote network when you connect to the VPN Client. Still, you can’t connect to the remote database.</li> </ul> <h1 id="naming-and-certificates">Naming and certificates</h1> <p>There’s another whole set of problems about DNS names and SQL Server certificates.<br /> The SQL Server has a <em>public</em> IP address, but Private Link also gives it a <em>Private</em> IP address. In my example here, they are 10.0.1.4 and 10.1.1.4 respectively. When you connect to the SQL Server over the VPN, you need to use the private IP address. So you may think you can just type 10.0.1.4 into PowerBI and start connecting. You will unfortunately get an “Encryption Support” error saying “The server name provided doesn’t match the server name on the SQL Server SSL certificate”.</p> <p>This makes sense; The SQL Server has a certificate that has been issued to <code class="highlighter-rouge">mydatabase.database.windows.net</code> (just like a website would) and when you try to connect to <code class="highlighter-rouge">10.0.1.4</code>, you get an error - just like you would in a web browser in the same situation.</p> <p>I am preparing a longer post on it, but the short version is this: <code class="highlighter-rouge">mydatabase.database.windows.net</code> is just a CNAME that points to <code class="highlighter-rouge">mydatabase.privatelink.database.windows.net</code>. You need to override the DNS resolution for the latter in your in your local DNS and then you can just connect to <code class="highlighter-rouge">mydatabase.database.windows.net</code>.</p> <p>I haven’t (yet) been able to show that you can override the <code class="highlighter-rouge">privatelink</code> entry in your HOSTS file and make it work; I am not sure it participates in the DNS chain in the same way. If you need to use a HOSTS file, you may need to override <code class="highlighter-rouge">mydatabase.database.windows.net</code>. More testing coming…</p> <p>Azure has support for Private DNS Zones - I am not sure they are applied to VPN clients yet. I’ll test and update this post when I know.</p> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2020/03/23/private-endpoints-vpn-and-more.html'; this.page.identifier = '/2020/03/23/private-endpoints-vpn-and-more.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2020/03/23/private-endpoints-vpn-and-more.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a rel="me" href="https://github.com/flytzen" target="_blank" alt="GitHub"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a rel="me" href="https://www.linkedin.com/in/flytzen/" target="_blank" alt="LinkedIn"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a rel="me" href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon" alt="Twitter"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> <a rel="me" href="https://hachyderm.io/@flytzen" target="_blank"> <svg style="width:24px;height:24px" fill="currentColor" viewBox="0 0 24 24" class="social-icon" alt="Mastodon"> <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2022 </div> </div> </footer> </body> </html>
