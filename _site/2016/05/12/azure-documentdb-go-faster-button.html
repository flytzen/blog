<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - Azure DocumentDb Go-Faster button</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content=""Premature optimisation is the root of all evil."That said, if you are using DocumentDb with the .Net client please do two things in your code right now. They are safe and they will speed up your database access - potentially by several orders of magnitude. I delayed putting it into..." />
</head>


  <body>

    <header class="site-header" role="banner">
  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/talks">Talks</a>
          <a class="page-link" href="/blog">Blog</a>
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Azure DocumentDb Go-Faster button</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2016-05-12T23:04:00+01:00" itemprop="datePublished">
          
          May 12, 2016
        </time>
        
          â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#CosmosDB">CosmosDB</a>
        &nbsp;
        
        <a href="/tags/#Azure">Azure</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <blockquote>"Premature optimisation is the root of all evil."</blockquote>That said, if you are using DocumentDb with the .Net client please do two things in your code right now. They are safe and they will speed up your database access - potentially by several orders of magnitude. I delayed putting it into my own application because I assumed that, like most of these things, it would only be a minor improvement in certain edge cases. In reality, I increased my sustained write speed by about 15x.<br /><br /><h4>Increase the connection limit</h4>If you do nothing else, at least stick this somewhere in your application startup. The most important bit is the DefaultConnectionLimit. The actual number you set for connection limit depends on your particular scenario. However, AFAIK, the main reason for keeping it low has to do with the risk of trading outbound connections for inbound connections in a web application - but if you have to worry about that, you almost certainly already know about it.<br /><pre class="prettyprint">    ServicePointManager.UseNagleAlgorithm = false;<br />    ServicePointManager.Expect100Continue = false;<br />    ServicePointManager.DefaultConnectionLimit = 10000;</pre><h4>Use direct connection</h4><i>Update: In SDK 1.9 Direct is now the default so you don't have to do this anymore</i><br />When you construct your document client, do it something like this:<br /><pre class="prettyprint">    return new DocumentClient(<br />            endpoint, <br />            secureKey, <br />            new ConnectionPolicy()<br />                {<br />                     ConnectionMode = ConnectionMode.Direct,<br />                     ConnectionProtocol = Protocol.Tcp<br />                });<br /></pre><br /><h1>Background</h1>You need to only have a single DocumentDb Client within you app domain - otherwise you may get intermittent socket errors. However, by default, the underlying .Net comms layer will only allow you to have two (2) concurrent connections. So, no matter how much you do in parallel or how many separate web requests you are serving, only two concurrent calls will be made to the database - which will completely kill your performance. Setting the DefaultConnectionLimit to a higher number allows you to have more parallel database connections and is genuinely DocumentDb's go-faster button.<br />The other bits on ServicePointManager are much more marginal but won't hurt and may help with other Azure services, including Table and Blob Storage.<br /><br /><i>Update: In SDK 1.9 Direct is now the default</i><br /><strike>Using the Direct Connection option when creating your DocumentClient is also pretty much a no-brainer. The default setting to use http and a gateway is just to make sure it "always works", even behind obscure corporate firewalls. Changing to Direct and Tcp is safe - the .Net SDK will handle the work for you so there is no extra code you have to write. I haven't measured how much extra raw performance it gives you and it may be somewhat marginal, but just get it in there while you are at it.</strike><br /><br />See also an example from Microsoft here: <a href="https://github.com/arramac/documentdb-partitioned-collections-demo/blob/master/ElasticCollectionsDemo/Program.cs">https://github.com/arramac/documentdb-partitioned-collections-demo/blob/master/ElasticCollectionsDemo/Program.cs</a>. They also increase the minimum number of active threads in the background thread pool. You may want to look at that too, I haven't tested it.
  </div>

  
    

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2016/05/12/azure-documentdb-go-faster-button.html';
      this.page.identifier = 'http://localhost:4000/2016/05/12/azure-documentdb-go-faster-button.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://flytzen.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  

  <a class="u-url" href="/2016/05/12/azure-documentdb-go-faster-button.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>

      <div class="footer-col footer-col-3">
        <p>My very infrequent thoughts on the world of software development</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
