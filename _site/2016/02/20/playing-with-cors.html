<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Playing with CORS</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="I recently had reason to get to understand CORS in a bit more detail and I wanted to share what I learned. I did this with ASP.Net 5 / MVC6 but the principles apply more broadly.This post is not&nbsp;about how to set up the built-in CORS middleware, but rather about..." /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Playing with CORS</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2016-02-20T21:41:00+00:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">20 Feb 2016</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#Web" class="icon__txt tag">Web</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> I recently had reason to get to understand CORS in a bit more detail and I wanted to share what I learned. I did this with ASP.Net 5 / MVC6 but the principles apply more broadly.<br />This post is <i>not</i>&nbsp;about how to set up the built-in CORS middleware, but rather about how to handle it yourself when you want and need to. Also, I am deliberately simplifying to make this just an introduction.<br />If you just want to get CORS handled by default, Microsoft has <a href="http://docs.asp.net/en/latest/security/cors.html">a great article on how to do this in ASP.Net 5 / MVC 6</a>.<br /><br /><h3>The biggest lesson</h3>The biggest lesson learned for me was that CORS does not (always) stop cross-origin requests from being sent to <i>and processed</i>&nbsp;on my server. It <i>does</i>&nbsp;stop the browser from giving the result back to the calling javascript.<br />What this means is that if you have a controller action in your ASP.Net application (and presumably the same in other frameworks) then it is entirely possible for javascript on a different site to call that API method and the code on your server <i>will</i>&nbsp;execute - it's just that the result will never get back to the calling javascript . Most of the time this is fine, assuming you are securing your controllers appropriately - but it is different from what I expected.<br /><br /><h3>Broad-brush CORS</h3>CORS is a security mechanism implemented in modern web browsers. In it's simplest terms, if you load a page from domain A and there is some javascript on that page which tries to get or post data to domain B then the browser will (usually) send that request over to domain B, but when it gets a response it will look for a set of headers that specify which domains are allowed to call services on domain B (along with some other restrictions). Note that the server will, by default, happily have processed the request and will have sent the result back - but the browser will check the headers that came back to see if the rules have been met and, if not, will discard the result and not give it back to the calling javascript.<br /><br />There is an important variation to this. Under certain circumstances, the browser will do a "preflight check" before it does the actual request. What this means is that the browser will send a request to domain B with a method OPTIONS (instead of GET or POST or whatever), in which it basically says to the server on domain B "hi, I'm just about to send you a request that looks like this. Can you just tell me which CORS headers you'd return if I did that?". If configured correctly, the server on domain B will respond with the appropriate headers and the browser will determine if it should send the actual request - or not.<br />There are a range of scenarios in which this preflight check will take place, usually if custom headers are involved or you try to send content other than plain text or form encoded (such as JSON or XML). But, it is important to understand a few things;<br /><br /><ol><li>There are scenarios where the preflight check will not take place so you cannot rely on the preflight check to keep you safe. In those cases, your controller will be called with the full payload and will execute normally - <i>even if you install the CORS middleware</i>.</li><li>CORS only really applies to requests from browsers so it doesn't, in any case, help against people who are attacking you directly.</li><li>&nbsp;If you do not have CORS middleware configured, preflight checks are passed to your controller actions. See below.</li></ol><div><br /></div><h3>Pre-flight checks without CORS middleware installed</h3>Let's say you have a simple API method like this;<br /><pre class="prettyprint">[Route("blah")]<br />[HttpPost]<br />public IActionResult Post(Model data)<br />{<br />    //Do stuff<br />}        <br /></pre>Now imagine a preflight check comes in. It will have a method of OPTIONS so you may assume it won't hit your controller - I mean you got that nice HttpPost attribute there, right? But part of the preflight check information is that it <i>wants</i>&nbsp;to do a POST, so the call will be passed to your controller - except without any body. So, if you are not using CORS middleware you may want to explicitly handle that situation like so;<br /><br /><pre class="prettyprint">[Route("blah")]<br />[HttpPost]<br />public IActionResult Post(Model data)<br />{<br />    if (this.Request.Method == "OPTIONS")<br />    {<br />       return this.Ok(); // Well, probably not what you want to do, but you get the idea<br />    }<br />}        <br /></pre><br />In conclusion, even if you don't expect to have to support CORS, <a href="http://docs.asp.net/en/latest/security/cors.html">install the middleware</a> and have one less thing to worry about.<br /><br /><h3>Manually handling CORS</h3><div>I have a scenario where I want to manually handle CORS. At <a href="http://www.neworbit.co.uk/">NewOrbit</a> we do a number of static marketing sites for people to help market the apps we build for them. Usually they need to have a contact form which means we build a quick bit of server-side code to do that - for each site.&nbsp;<a href="http://formspree.io/">http://formspree.io/</a>&nbsp;was pointed out to us as a way to make it more simple - and a very nice solution it is. But I was curious about whether we could build something like that ourself, just for fun. Formspree allows you to do just do a FORM POST, which doesn't involve Origin headers (well, Chrome sends it but Firefox doesn't) I wanted to be able to control which sites were able to send emails via the service, which I can do by handling CORS myself, directly in my controller. This does mean the clients can't just do a FORM POST, they'll have to use javascript though.<br />Some benefits of this include;</div><div><ul><li>I can dynamically add new sites that are allowed.</li><li>When responding to requests, I can just return the one site that is actually asking, rather than a list of all the allowed sites.</li></ul><div>My implementation looks something like this;</div></div><pre class="prettyprint">public IActionResult Post([FromBody]dynamic data)<br />{<br />    var originHeader = this.GetOriginHeader();<br />    if (!this.IsValidOrigin(originHeader))<br />       return new ContentResult() { StatusCode = 403, Content = "Invalid origin" };<br />    }<br /><br />    this.AddCORSHeaders(originHeader);<br />    if (this.Request.Method == "OPTIONS")<br />    {<br />        return this.Ok();<br />    }<br /><br />    // Chrome sets the Origin header on a cross-domain post. Sadly, Firefox doesn't, so I can't allow plain form posts.<br />    return new ContentResult() { StatusCode = 200, Content = this.Request.Method };<br />}<br /><br />private void AddCORSHeaders(string originHeader)<br />{<br />    this.Response.Headers.Add("Access-Control-Allow-Origin", originHeader);<br />    this.Response.Headers.Add("Access-Control-Allow-Methods", "POST");<br />    this.Response.Headers.Add("Access-Control-Allow-Headers", "Content-Type");<br />}<br /><br />private string GetOriginHeader()<br />{<br />    var originHeaders = this.Request.Headers["Origin"];<br />    if (originHeaders.Count != 1)<br />    {<br />       return null;<br />    }<br />    return originHeaders[0];<br />}<br /><br />private bool IsValidOrigin(string origin)<br />{<br />    if (String.IsNullOrEmpty(origin))<br />    {<br />       return false;<br />    }<br />    return origin == "http://localhost:5001";<br />}<br /></pre></div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2016/02/20/playing-with-cors.html'; this.page.identifier = '/2016/02/20/playing-with-cors.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2016/02/20/playing-with-cors.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a href="https://github.com/flytzen" target="_blank" alt="GitHub"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a href="https://www.linkedin.com/in/flytzen/" target="_blank" alt="LinkedIn"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon" alt="Twitter"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> <a rel="me" href="https://hachyderm.io/@flytzen" target="_blank"> <svg style="width:24px;height:24px" fill="currentColor" viewBox="0 0 24 24" class="social-icon" alt="Mastodon"> <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2022 </div> </div> </footer> </body> </html>
