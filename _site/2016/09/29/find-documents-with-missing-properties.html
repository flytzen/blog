<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - Find Documents with missing properties in Azure DocumentDb with the .Net SDK</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content="Azure DocumentDb stores documents as JSON. One of the effects of this is that sometimes you may end up with documents in the database that have missing properties and it can be quite tricky to search for them with the .Net SDK. This blog post has an approach to doing..." />
</head>


  <body>

    <header class="header" role="banner">
  <div class="wrapper">
    
    
    <a class="header__title" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="header__nav">
          <a class="header__nav-link" href="/talks">Talks</a>
          <a class="header__nav-link" href="/blog">Blog</a>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Find Documents with missing properties in Azure DocumentDb with the .Net SDK</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2016-09-29T21:06:00+01:00" itemprop="datePublished">
          
          Sep 29, 2016
        </time>
        
          â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#CosmosDB">CosmosDB</a>
        &nbsp;
        
        <a href="/tags/#Azure">Azure</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    Azure DocumentDb stores documents as JSON. One of the effects of this is that sometimes you may end up with documents in the database that have missing properties and it can be quite tricky to search for them with the .Net SDK. This blog post has an approach to doing it - and quite simply too.<br /><br /><h3>Background</h3><div>Most commonly, you would encounter the issue of the missing property when you add a new property to an existing class in your .Net code. There is no automatic method of adding this new property to all the existing entries in the database, short of re-saving them all.</div><div><br /></div><div>Alternatively, you can explicitly configure Json.Net to not store properties that have null values like this:</div><pre class="prettyprint">JsonConvert.DefaultSettings = () =&gt; <br />  new JsonSerializerSettings<br />       {<br />          NullValueHandling = NullValueHandling.Ignore<br />       };<br /></pre><br /><div>You can use this configuration option to test the behaviour I am describing here or to save space in the database.<br /><br />For example, imagine you have a class called MyItem looking like this:</div><pre class="prettyprint">public class MyItem<br />{<br />    [JsonProperty("id")]<br />    public string Id { get; set; }<br />    public string SomeValue { get; set; }<br />}<br /></pre><br /><div>If you have an item where SomeValue is null, by default that will be serialised and stored in DocumentDb like this:</div><pre class="prettyprint">{<br />  "id" : "1",<br />  "SomeValue" : null<br />}<br /></pre><br /><div>However, if you configure Json.Net to not store null values (or the SomeValue field was added to your .Net code after you stored this item in DocumentDb) it will look like this in the database:</div><pre class="prettyprint">{<br />  "id" : "1",<br />}<br /></pre><br /><br /><h3>Selecting missing properties with SQL</h3><div>According to&nbsp;<a href="https://azure.microsoft.com/en-gb/documentation/articles/documentdb-sql-query/">the documentation</a>&nbsp;you can use SQL to select missing properties like this:</div><pre class="prettyprint">SELECT f.lastName ?? f.surname AS familyName<br />FROM Families f<br /></pre><div>You can then extrapolate from that example to, for example, select items etc.<br /><br /></div><div><h3>Finding items with null <i>or</i>&nbsp;missing with the .Net SDK</h3></div><div>Imagine you have added the SomeValue property to the MyItem class after you had already saved some items. Further, sometimes you store a null in the SomeValue property. Or you have configured Json.Net to ignore null values. And now you want to find all the items where SomeValue is either missing or null.</div><div>You might try this:&nbsp;</div><pre class="prettyprint">var query1 = client.CreateDocumentQuery&lt;MyItem&gt;(collectionUrl)<br />              .Where(i =&gt; i.SomeValue == null);<br /></pre><div>But you will find that this will not actually return any results - at least, it won't return any documents where SomeValue is not present at all. However, this odd-looking statement will work:</div><pre class="prettyprint">var query2 = client.CreateDocumentQuery&lt;MyItem&gt;(collectionUrl)<br />              .Where(i =&gt; (i.SomeValue ?? null) == null);<br /></pre><div><br /></div><div>It is using the null coalescor to make DocumentDb return a null value for the property for the property if it does not exist, which we can then compare to null.<br /><br />I have tested this with version 1.6, 1.8 and 1.10 of the SDK, but I would advise you to put an integration test in your code if you are going to rely on it, just in case the behaviour changes in the future. You'll probably also want to put a comment wherever you use this syntax as R# is quite keen to tell you that you should get rid of the "?? null" part.<br />Finally, I have not done any performance testing on this, but I suspect DocumentDb won't be able to use any indexes to execute this query; it will probably have to evaluate each document in a scan so use with caution.</div><br /><h3>A full sample</h3><div>If you want to try this out, there is a full example here:&nbsp;<a href="https://gist.github.com/flytzen/b8dbcb2079a66b1c8a67005ef5198052">https://gist.github.com/flytzen/b8dbcb2079a66b1c8a67005ef5198052</a></div><div><br /></div>
  </div>

  
    
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2016/09/29/find-documents-with-missing-properties.html';
      this.page.identifier = '/2016/09/29/find-documents-with-missing-properties.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://flytzen.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  

  <a class="u-url" href="/2016/09/29/find-documents-with-missing-properties.html" hidden></a>
</article>

      </div>
    </main>

    <!-- <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>

      <div class="footer-col footer-col-3">
        <p>My very infrequent thoughts on the world of software development</p>
      </div>
    </div>

  </div>

</footer> -->


  </body>

</html>
