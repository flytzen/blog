<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Azure SQL Private End Points with Pulumi</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="Configure Private End Points on Azure SQL Server with Pulumi" /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Azure SQL Private End Points with Pulumi</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2021-02-16T00:00:00+00:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">16 Feb 2021</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#Azure" class="icon__txt tag">Azure</a> <a href="/tags/#Pulumi" class="icon__txt tag">Pulumi</a> <a href="/tags/#Network" class="icon__txt tag">Network</a> <a href="/tags/#Security" class="icon__txt tag">Security</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> <p>Private End Points are the right way to connect PaaS Services to vNets so they can be accessed from other resources on the vNet. There are other, older, ways but they are not as good. Unfortunately, Private End Points require understanding quite a few things, including DNS resolution, split-brain DNS and a bunch of weird abstractions. This <a href="https://docs.microsoft.com/en-us/azure/private-link/create-private-endpoint-cli">Microsoft post</a> gives a good example of how to set it up with Azure SQL. This post does essentially the same thing, except it does not create a VM. Anything related to the VM is left out here.</p> <p>This is part of a <a href="https://github.com/NewOrbit/AzureVnetPassSamples">bigger project</a> I am working on to set up a complex vNet-and-PasS setup in Azure with multiple services, regions and VPN clients.</p> <h1 id="before-we-can-add-the-private-end-point">Before we can add the private end point</h1> <p>This bit here sets up a network and a SQL Server so we can add the private end point.</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resourceGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">ResourceGroup</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">location</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest</span><span class="dl">"</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">vnet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">VirtualNetwork</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-vn</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">virtualNetworkName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-vn</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">addressSpace</span><span class="p">:</span> <span class="p">{</span> <span class="na">addressPrefixes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">10.0.0.0/16</span><span class="dl">"</span><span class="p">]</span> <span class="p">},</span>
    <span class="nx">location</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">azureSqlSubnet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">Subnet</span><span class="p">(</span><span class="dl">"</span><span class="s2">azure-sql</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">subnetName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">azure-sql</span><span class="dl">"</span><span class="p">,</span> 
    <span class="na">addressPrefix</span><span class="p">:</span> <span class="dl">"</span><span class="s2">10.0.4.0/24</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">virtualNetworkName</span><span class="p">:</span> <span class="nx">vnet</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">privateEndpointNetworkPolicies</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Disabled</span><span class="dl">"</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">passSqlServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">v20200801preview</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-ss</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="na">serverName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-ss</span><span class="dl">"</span><span class="p">,</span>
        <span class="nx">administratorLogin</span><span class="p">,</span>
        <span class="nx">administratorLoginPassword</span><span class="p">,</span>
        <span class="nx">location</span><span class="p">,</span>
        <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">tags</span><span class="p">,</span>
        <span class="na">minimalTlsVersion</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.2</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">});</span>
</code></pre></div></div> <h1 id="setting-up-the-private-end-point">Setting up the private end point</h1> <p><em>This is the important bit</em></p> <h3 id="first-add-a-private-dns-zone-and-link-it-to-the-network">First, add a Private DNS Zone and link it to the network</h3> <p>You need to do this <em>once</em> per vnet, no matter how many SQL Servers you have in that vNet. You will need to do this for each type of service, i.e you’d need something similar for Storage etc. This is required in order to make DNS lookups for the SQL Server return the <em>local</em> IP address, rather than the public one. The tricky bit is that an Azure SQL Server will always have a <em>public</em> IP Address, even if no public access is allowed. When you set up the DNS resolution just right, a DNS lookup on your private network will return the private IP address and when you look it up on the public internet, you will see the public IP address. There is a lot more detail to this, but that is for another post. What is described here is the easiest and most reliable way to make this work. There <em>are</em> other ways, but they require more knowledge and more work.</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Sets up a private DNS Zone for SQL private link entries</span>
<span class="kd">const</span> <span class="nx">sqlPrivateDns</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">PrivateZone</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-sqldns</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">privateZoneName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">privatelink.database.windows.net</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">global</span><span class="dl">"</span> <span class="c1">//https://github.com/Azure/azure-cli/issues/6052</span>
<span class="p">})</span>

<span class="c1">// Links the private DNS Zone to the vnet</span>
<span class="kd">const</span> <span class="nx">dnsVnetLink</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">VirtualNetworkLink</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-vnl</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">privateZoneName</span><span class="p">:</span> <span class="nx">sqlPrivateDns</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">virtualNetworkLinkName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-vnl</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">registrationEnabled</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">virtualNetwork</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">vnet</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span>
    <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">global</span><span class="dl">"</span>
<span class="p">})</span>
</code></pre></div></div> <h3 id="set-up-a-private-end-point-for-the-sql-server">Set up a Private End Point for the SQL Server</h3> <p>You need to do this for each SQL Server in your vnet</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Create the private end point for the SQL Server</span>
<span class="kd">const</span> <span class="nx">sqlPrivateEndPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">PrivateEndpoint</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-sqlpep</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">privateEndpointName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-sqlpep</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="nx">location</span><span class="p">,</span>
    <span class="na">subnet</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">azureSqlSubnet</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span>
    <span class="na">privateLinkServiceConnections</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sql</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">privateLinkServiceId</span><span class="p">:</span> <span class="nx">passSqlServer</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="na">groupIds</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">sqlServer</span><span class="dl">"</span><span class="p">],</span> <span class="c1">// This particular group id is not documented by Azure that I can see - I found it by trying to do this manually in the portal</span>
            <span class="na">privateLinkServiceConnectionState</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">actionsRequired</span><span class="p">:</span> <span class="dl">"</span><span class="s2">None</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Auto-approved</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Approved</span><span class="dl">"</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">})</span>

<span class="c1">// Connects the private DNS Zone and the private end point (I think)</span>
<span class="kd">const</span> <span class="nx">sqlPrivateDnsZoneGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">PrivateDnsZoneGroup</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-sqldnsgroup</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">privateDnsZoneGroupName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-sqldnsgroup</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">privateEndpointName</span><span class="p">:</span> <span class="nx">sqlPrivateEndPoint</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-sqldns</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">privateDnsZoneConfigs</span><span class="p">:</span> <span class="p">[{</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">sqlPrivateDns</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="na">privateDnsZoneId</span><span class="p">:</span> <span class="nx">sqlPrivateDns</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}]</span>
<span class="p">})</span>

</code></pre></div></div> <h1 id="connect-a-web-app">Connect a Web App</h1> <p>If you want to connect a web app to the vNet so it can talk to the SQL (not really the scope of this post, but hey) then do the following. Note, this is <em>outbound</em> from the Web App. Inbound traffic <em>to</em> the Web App is best handled by setting up a Private End Point for the Web App - though that currently requires a Premium App Service Plan. Service End Points is another option but they are much harder to use in my experience and I don’t recommend them.</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Set up a subnet dedicated as an entry point for Web Apps</span>
<span class="kd">const</span> <span class="nx">frontEndSubnet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">Subnet</span><span class="p">(</span><span class="dl">"</span><span class="s2">front-end</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">subnetName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">front-end</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">addressPrefix</span><span class="p">:</span> <span class="dl">"</span><span class="s2">10.0.1.0/24</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">virtualNetworkName</span><span class="p">:</span> <span class="nx">vnet</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">delegations</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="na">serviceName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Microsoft.Web/serverfarms</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">front-end-delegation</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">});</span>

<span class="c1">// Add an app service plan and a web app</span>
<span class="kd">const</span> <span class="nx">appServicePlan</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">AppServicePlan</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-as</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-as</span><span class="dl">"</span><span class="p">,</span>
    <span class="nx">location</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">sku</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">family</span><span class="p">:</span> <span class="dl">"</span><span class="s2">S</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">capacity</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">size</span><span class="p">:</span> <span class="dl">"</span><span class="s2">S1</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">S1</span><span class="dl">"</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">appService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">WebApp</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-wa</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">fl-vnettest-wa</span><span class="dl">"</span><span class="p">,</span>
        <span class="nx">location</span><span class="p">,</span>
        <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="na">clientAffinityEnabled</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">httpsOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">serverFarmId</span><span class="p">:</span> <span class="nx">appServicePlan</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="nx">tags</span><span class="p">,</span>
        <span class="na">siteConfig</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">appSettings</span><span class="p">:</span> <span class="p">[</span>
                <span class="c1">// This is critical to make DNS lookups return the internal IP Address. </span>
                <span class="c1">// Without it, your web app will get the public IP address of the SQL Server and will be denied access. </span>
                <span class="c1">// 168.63.129.16 is a magic constant provided by Microsoft and works with the setup above. </span>
                <span class="c1">// You will only need something different if you use your own DNS servers.</span>
                <span class="c1">// See https://feedback.azure.com/forums/169385-web-apps/suggestions/38383642-web-app-and-private-dns-zone-support</span>
                <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">WEBSITE_DNS_SERVER</span><span class="dl">"</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">168.63.129.16</span><span class="dl">"</span> <span class="p">},</span> 
                <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">WEBSITE_VNET_ROUTE_ALL</span><span class="dl">"</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span> <span class="p">},</span>
                <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hostname</span><span class="dl">"</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="nx">passSqlServer</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">.database.windows.net</span><span class="dl">"</span><span class="p">)</span> <span class="p">},</span>
                <span class="p">{</span>
                    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sql</span><span class="dl">"</span><span class="p">,</span>
                    <span class="na">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Server=tcp:fl-vnettest-ss.database.windows.net,1433;Initial Catalog=fl-vnettest-db;Persist Security Info=False;User ID=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">administratorLogin</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">;Password=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">administratorLoginPassword</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;</span><span class="dl">"</span>
                    <span class="c1">// Note: This isn't ideal for many reasons, but I haven't got the brain power to nest apply calls :)</span>
                <span class="p">}</span>    
            <span class="p">]</span>
        <span class="p">},</span>
    <span class="p">})</span>

<span class="c1">// Give the web app access to the vnet &lt;- the thing you actually wanted to see :)</span>
<span class="c1">// Note that "Swift" is the "modern" way of doing this. Don't do what I do and spend ours trying to make WebAppVnetConnection work - it won't.</span>
<span class="kd">const</span> <span class="nx">webAppVNetConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">WebAppSwiftVirtualNetworkConnection</span><span class="p">(</span><span class="dl">"</span><span class="s2">fl-vnettest-wa-vc</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="nx">appService</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">resourceGroupName</span><span class="p">:</span> <span class="nx">resourceGroup</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">subnetResourceId</span><span class="p">:</span> <span class="nx">frontEndSubnet</span><span class="p">.</span><span class="nx">id</span>
<span class="p">})</span>

</code></pre></div></div> <h1 id="references">References</h1> <ul> <li><a href="https://www.pulumi.com/docs/reference/pkg/azure-nextgen/">Pulumi Azure Next Gen API Reference</a></li> <li><a href="https://docs.microsoft.com/en-us/azure/private-link/create-private-endpoint-cli">Quickstart: Create a Private Endpoint using Azure CLI</a></li> <li><a href="https://github.com/pulumi/pulumi-azure-nextgen/issues/227">Unable to provision PrivateDnsZoneGroup</a></li> <li><a href="https://github.com/NewOrbit/AzureVnetPassSamples">AzureVnetPassSamples repo (work in progress)</a></li> <li><a href="https://feedback.azure.com/forums/169385-web-apps/suggestions/38383642-web-app-and-private-dns-zone-support">Web App and Private DNS zone support</a></li> </ul> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2021/02/16/pulumi-sql-private-end-point.html'; this.page.identifier = '/2021/02/16/pulumi-sql-private-end-point.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2021/02/16/pulumi-sql-private-end-point.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a href="https://github.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a href="https://www.linkedin.com/in/flytzen/" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2022 </div> </div> </footer> </body> </html>
