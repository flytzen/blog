<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - Azure Failover and Resilience</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content="Azure provides a highly resilient hosting platform, with significant built-in redundancy, but it can be hard to understand what resilience you get automatically and what you might have to set up yourself." />
</head>


  <body>

    <header class="header" role="banner">
  <div class="wrapper">
    
    
    <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="header__nav">
          <a class="header__nav-link" href="/talks">Talks</a>
          <a class="header__nav-link" href="/blog">Blog</a>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Azure Failover and Resilience</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2017-06-29T17:54:00+01:00" itemprop="datePublished">
          
          Jun 29, 2017
        </time>
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#Azure">Azure</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    Azure provides a highly resilient hosting platform, with significant built-in redundancy within a data centre, as well as the presence of more than 30 data centres across the world.<br /><br />When first coming to Azure, it can be hard to understand what resilience you get automatically and what you might have to set up yourself.<br /><br />This post provides a high-level overview of the principles. It is intended as an introduction to help you ask the right questions.<br /><br />The usual starting point for a system is to host it in a single data centre. Azure is highly resilient even within a single data centre, but even so, all the data is continually backed up to a secondary data centre.<br /><br />In the case of a complete failure of a data centre, the data can be restored to another data centre. This is not the same as automatic failover to another data centre; In order to get the data restored in the other data centre and get the system back up and running, you will have to do it yourself; Azure will (for the most part) not do this for you. How much work depends on how much preparatory work has been done and is primarily a business decision based on risk and cost.<br /><br />Any conversation about failover is complicated by the fact that a system consists of different components, which can fail independently, which have different probability and impact and which require different failover strategies.<br /><br />Before going into the details, it is important to understand that even the most basic setup in Azure has a very high level of resilience with each individual component typically having a guaranteed uptime of 99.95% or more. At the same time, data is continually backed up to a secondary data centre. In other words, even the most basic Azure setup has a level of resilience that is difficult and expensive to achieve with on-premise hosting.<br /><br />In this post “failover” will refer to failing over between data centres.<br /><br /><h4>Resilience in a single data centre</h4><div>Azure Data Centres are built in a modular way, meaning that each data centre can be thought of as many smaller data centres built next to each other. This means that your data and system will be physically spread over different parts of the data centre, in turn meaning that even if an entire part of the data centre fails, you are unlikely to notice.<br /><br /></div>Physically, all Azure data centres have multiple redundant power grid connections, multiple redundant internet connections, redundant backup generators, batteries and so on and so forth.<br /><br />As a general rule, any data you save in Azure, in databases, to disk or to other types of storage, is written to three different locations inside that one data centre and a single copy is written to another remote data centre as a backup. For example the London data centre backs up to Cardiff and the Amsterdam data centre backs up to Dublin etc.<br /><br />Azure App Service has some built-in resilience so even with only a single compute node in your app hosting plan, you are pretty well protected from outages. With Cloud Services, you must ensure that you have at least two instances running at all times to ensure resilience. With Virtual Machines – you are much more on your own, though there are a number of things you can configure, such as Availability Sets etc. As a <i>very</i> general rule, to make reliability easier, avoid using VMs, use one of the managed options instead, when you can.<br /><br />When you want to be able to fail over to another data centre, there are several options available to you. I have grouped them here under “Cold”, “Warm” and “Hot”. These are just convenience labels and may not correlate to other people’s definitions.<br /><br /><h4>Cold</h4><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-wV3fbqWMgeU/WVUssFhNeqI/AAAAAAAALuA/n5RZdmPeCqM4Jr6snqblsOxVj7fUfEyvQCLcBGAs/s1600/Failover%2BOptions%2B-%2BCold.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" data-original-height="560" data-original-width="1180" height="188" src="https://4.bp.blogspot.com/-wV3fbqWMgeU/WVUssFhNeqI/AAAAAAAALuA/n5RZdmPeCqM4Jr6snqblsOxVj7fUfEyvQCLcBGAs/s400/Failover%2BOptions%2B-%2BCold.png" width="400" /></a></div><div>A Cold failover is what you get by default.</div><div><br /></div>Your data is automatically backed up to another data centre. In the case of a failure of the primary data centre, you can go to the other data centre, set up your systems again, deploy everything and restore your database. Of course, the more automated your deployment is, the easier this will be.<br /><br />You should be aware that while you can manually trigger a restore of SQL and CosmosDB databases, you cannot yourself trigger a “restore” of anything you put into Azure Storage. Microsoft has to do that by changing DNS entries and their SLA on that is up to 48 hours, last time I checked. There are things you can do to improve this, such as using read-access geo-redundant storage, but you will need to develop specifically to take advantage of that. Often, though, the data in Azure Storage is secondary to the main system and you may be able to live without that data for a day or two.<br /><br />The exact frequency of database backups depends on the chosen database but is generally four hours or less.<br /><br /><h4>Warm</h4><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-gk1abFDNI6A/WVUtOZGJaeI/AAAAAAAALuE/gEM_835uULUHb8zijsbskKBwbgclBf2zgCLcBGAs/s1600/Failover%2BOptions%2B-%2BWarm.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" data-original-height="560" data-original-width="1180" height="188" src="https://4.bp.blogspot.com/-gk1abFDNI6A/WVUtOZGJaeI/AAAAAAAALuE/gEM_835uULUHb8zijsbskKBwbgclBf2zgCLcBGAs/s400/Failover%2BOptions%2B-%2BWarm.png" width="400" /></a></div>A Warm failover allows faster fail-over to a secondary data centre, but still requires manual intervention.<br /><br />In order to reduce the time it takes to move to a secondary data centre, it is possible to prepare the infrastructure and have detailed plans in place. You can do this by configuring the whole system in the secondary data centre but not deploy anything to it; For many services you can define it but just not deploy anything to it. Similarly, you can deploy VMs and then de-allocate them etc. An alternative is to create an ARM template, which will allow you to quickly create a whole environment in Azure.<br /><br />You should also write plans and scripts so you can quickly restore the databases and direct traffic to the other data centre etc. It may also require periodic testing of the plans.<br /><br />Finally, you should make sure your DNS is set up with a short enough TTL that you can quickly move traffic to the new websites.<br /><br />Document storage, such as files, may in the Warm scenario still take up to 48 hours to be made available in the other data centre.<br /><br /><h4>Hot</h4><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-jR6utAG2ch0/WVUtUWoKCoI/AAAAAAAALuI/uwkuqU-cVuIUfrzgbYqs1QsXDfgPzYemgCLcBGAs/s1600/Failover%2BOptions%2B-%2BHot.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" data-original-height="980" data-original-width="1180" height="331" src="https://1.bp.blogspot.com/-jR6utAG2ch0/WVUtUWoKCoI/AAAAAAAALuI/uwkuqU-cVuIUfrzgbYqs1QsXDfgPzYemgCLcBGAs/s400/Failover%2BOptions%2B-%2BHot.png" width="400" /></a></div>A Hot failover will automatically fail over to a secondary data centre if the primary data centre fails, in whole or in part.<br /><br />In practice, there are many different components to a system and it usually makes sense to only have hot failover in place for some of the components. A bespoke cost/benefit exercise should be carried out where hot failover is desired.<br /><br />The primary things to consider;<br /><br /><h3>Web site failover</h3>It is possible to deploy the front-end web servers &nbsp;to more than one data centre and use Traffic Manager to automatically direct traffic between the two. This works with most kinds of web hosting you can do in Azure. This means that if the websites in one data centre fails, requests will automatically be served by the other data centre, usually within 1 minute. The main costs are in paying for the extra server(s) and the added complexity in every deployment.<br /><br /><h3>Database failover</h3>Azure offers hot failover for both Azure SQL and CosmosDB, the two main databases. With this failover, Azure will dynamically fail over to a secondary data centre in case of a failure and/or serve requests from both data centres. The mechanisms used by SQL Azure and CosmosDB are fundamentally different and will require different approaches.<br /><br />&nbsp;As a general rule, you have to pay for two copies of your database and you may have to use a more expensive service tier.<br /><br />In the case of CosmosDB, it may be required to consider consistency levels and the system may need to be adapted to deal with this.<br /><br /><h3>Storage failover</h3>It is common to store files and certain other types of data in Azure Storage. By default, data is backed up to another data centre (though this can be disabled when not required). However, Azure is in control of enabling access to the backup in case of a failure and the SLA is up to 48 hours. In many cases, this is acceptable as the loss of access to historical files may be considered a service degradation rather than a failure.<br /><br />Where required, Azure do provide ways to have direct access to a read-only copy in the secondary data centre. This can be utilised to build a very high level of resilience, but it requires explicit programming in your software to take advantage of this.<br /><br /><h3>Queue failover</h3>In an effort to increase resilience and scalability, it is common to use queues in systems; Rather than do something straight away, the system will put a message on a queue and a background job will then process this. This design has many benefits, including automatic retrying, resilience to external systems being down and significant scale benefits as sudden peaks in demand just causes queues to get longer for a little while.<br />This does, however, mean that the queues can be a single point of failure; if the queue service fails, you can no longer enqueue messages.<br /><br />From NewOrbit’s many years of working with Azure, it is clear that Microsoft are very aware of the crucial importance queues play in many systems and they have worked very hard to make them extremely resilient; Despite very extensive usage, NewOrbit has never experienced a failure with “storage queues” and has only experienced an issue with “service bus queues” on a single occasion in 2013.<br /><br />It is possible to implement failover for queues and NewOrbit has done that before. There are different approaches that can be taken and Service Bus Queues have some native support for failover, though it does require programming to take full advantage of it.<br /><br /><h3>Other items</h3>There are many other items that can be used in Azure, including virtual machines. For most of these items, a bespoke failover strategy is required to achieve hot failover.<br /><br /><h4>More SLA details</h4>The individual SLAs for all Azure services can be found at https://azure.microsoft.com/en-gb/support/legal/sla/<br />If you need to report on your overall SLA, it is important to understand how to combine them. If you have, say, an Azure App Service with 99.95% SLA and an Azure SQL database with a 99.99% SLA then the overall SLA for both to be up is (99.95% x 99.99%) = 99.94%. This obviously compounds with more components.<br /><br />On the other hand, adding a hot failover App Service in another data centre using Traffic Manager means you now have a better than 99.95% expected SLA for the App Service component. However, calculating the actual SLA is not practical due to the presence of “systemic risk”; There is one risk of a single data centre going down and a separate risk of a worldwide outage of Azure App Services.<br /><br /><h4>Help?</h4><div>If you have a quick question, ping me on <a href="https://www.twitter.com/flytzen" target="_blank">twitter</a>.</div><div><br /></div><div>If you want more extensive advice and guidance, my company <a href="http://www.neworbit.co.uk/" target="_blank">NewOrbit</a> offers help to other companies who are moving to Azure. We have been building systems on Azure since 2011 and are a Microsoft Cloud Gold Partner.</div><br />
  </div>

  
    
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2017/06/29/azure-failover-and-resilience.html';
      this.page.identifier = '/2017/06/29/azure-failover-and-resilience.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://flytzen.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  

  <a class="u-url" href="/2017/06/29/azure-failover-and-resilience.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="footer">

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>
      
    </div>

  </div>

</footer>


  </body>

</html>
