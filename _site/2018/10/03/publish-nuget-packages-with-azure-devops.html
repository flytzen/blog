<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Publish Nuget packages with Azure Dev Ops</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="Use GitFlow and Azure Devops to automatically publish Nuget packages with sensible version numbers" /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Publish Nuget packages with Azure Dev Ops</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2018-10-03T00:00:00+01:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">03 Oct 2018</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#DevOps" class="icon__txt tag">DevOps</a> <a href="/tags/#Azure" class="icon__txt tag">Azure</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> <blockquote> <p>Update: Do NOT use Build.Id as part of your version number. .Net limits the revision number to max 65535 but the Build.Id can be bigger, which may cause your build to all of a sudden start to fail.</p> </blockquote> <p>Whenever I decide to create a Nuget package, whether for OSS or to publish on our internal MyGet feed I end up spending an inordinate amount of time trying to figure out a flow that works for testing and publishing. I guess it’s one of those things that, once you have figured it out, becomes easy but it has eluded me until recently.</p> <p>My requirements are quite specific and may not be to everyone’s liking;</p> <ul> <li>I want to use <a href="https://datasift.github.io/gitflow/IntroducingGitFlow.html">GitFlow</a> to control my branches, including using Pull Requests etc.</li> <li>Whenever a commit is made to <code class="highlighter-rouge">develop</code> (or a PR is merged in), I want to publish that package with a “<code class="highlighter-rouge">-pre.123</code>” suffix as per <a href="https://semver.org/">SemVer</a></li> <li>Whenever the same happens to <code class="highlighter-rouge">master</code> I want to publish a “full” release.</li> </ul> <p>I haven’t explicitly covered it here, but it would also be nice to have packages sat in a <code class="highlighter-rouge">release/*</code> branch be published with a <code class="highlighter-rouge">-beta.1</code> suffix - but you can easily extend it to cover that scenario as well.</p> <p>In this post I will show how to set up GitHub with Azure DevOps to do this for us.</p> <p>I am basing this on “modern” (i.e. 2017) csproj files, the ones where the package references are in the .csproj files. This came in with .Net Core but works fine with Full Framework projects.</p> <h2 id="version-numbers">Version numbers</h2> <p>When you create and publish Nuget packages you can specify the version number you want to use on the command line and there is ample of documentation about how to do that with Azure DevOps and other builder services, including MyGet build services, which I used previously.<br /> However, I really like more control so I like to control the version number in my .csproj file - but I want the build service to automatically append <code class="highlighter-rouge">-pre.nnn</code> when it published from the <code class="highlighter-rouge">develop</code> branch.</p> <p>The first thing to understand is that there are two ways you can specify the version number in your <code class="highlighter-rouge">.csproj</code> file:</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;version&gt;</span>1.2.3-pre.987<span class="nt">&lt;/version&gt;</span>
</code></pre></div></div> <p>or</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;VersionPrefix&gt;</span>1.2.3<span class="nt">&lt;/VersionPrefix&gt;</span>
<span class="nt">&lt;VersionSuffix&gt;</span>pre.987<span class="nt">&lt;/VersionSuffix&gt;</span>
</code></pre></div></div> <p>Both the above will create packages with version <code class="highlighter-rouge">1.2.3-pre.987</code>. The naming of the Prefix and Suffix threw me for the longest time - I thought they were meant to interact with the <code class="highlighter-rouge">&lt;Version&gt;</code> attribute somehow, but Prefix and Suffix is more like “main part” and “extra bit” and you should <em>either</em> those <em>or</em> <code class="highlighter-rouge">&lt;Version&gt;</code>.</p> <p>The second thing to understand is that you can use conditionals and environment variables in the attributes. For my purposes, this is what I ended up with:</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;VersionPrefix&gt;</span>1.2.3<span class="nt">&lt;/VersionPrefix&gt;</span>
<span class="nt">&lt;VersionSuffix&gt;&lt;/VersionSuffix&gt;</span>
<span class="nt">&lt;VersionSuffix</span> <span class="na">Condition=</span><span class="s">" '$(Configuration)' == 'Debug' "</span><span class="nt">&gt;</span>debug<span class="nt">&lt;/VersionSuffix&gt;</span> <span class="c">&lt;!-- For local/debug builds --&gt;</span>
<span class="nt">&lt;VersionSuffix</span> <span class="na">Condition=</span><span class="s">" '$(Build_SourceBranch)' == 'refs/heads/develop' "</span><span class="nt">&gt;</span>pre.$(Build_BuildID)<span class="nt">&lt;/VersionSuffix&gt;</span> <span class="c">&lt;!-- This is using variables that are specific to Azure Dev Ops Pipelines --&gt;</span>
</code></pre></div></div> <p>My <code class="highlighter-rouge">&lt;VersionPrefix&gt;</code> here is really the proper version I want my package to have.<br /> I have an empty <code class="highlighter-rouge">&lt;VersionSuffix&gt;</code> as default. I probably don’t actually need that tag, but it helps make it clearer in my mind.</p> <p>The next <code class="highlighter-rouge">&lt;VersionSuffix&gt;</code> uses the <code class="highlighter-rouge">Configuration</code> variable that is provided by the dotnet build process; if I build in Debug mode, the package version will become <code class="highlighter-rouge">1.2.3-debug</code>. This is mainly useful for local scenarios as I will always build in Release mode for publishing.</p> <p>The <code class="highlighter-rouge">&lt;VersionSuffix&gt;</code> after that looks at an environment variable provided by Azure DevOps when you are running in the pipeline. This means that if I am building from the <code class="highlighter-rouge">develop</code> branch in an Azure Pipeline then it will set the Suffix. <code class="highlighter-rouge">Build_BuildID</code> is another environment variable provided by Azure Dev Ops to the pipeline, which will always increment. So, in the example here I may end up with a version number of <code class="highlighter-rouge">1.2.3-pre.6239</code>. As long as that last number reliably increments (which it does) you are fine for package control.<br /> There is another variable called <code class="highlighter-rouge">Build_BuildNumber</code> which you may be tempted to use instead. However, I found some scenarios where that variable would have the name of the pipeline instead of a number, which causes the build to fail.</p> <p>For more advanced scenarios you can invent your own attributes, which become variables in their own right, which you can then re-combine in other ways.</p> <h2 id="publish-symbols">Publish Symbols</h2> <p>Traditionally, when you create a Nuget package, it <em>won’t</em> include the <code class="highlighter-rouge">pdb</code> files (the debug symbols). In the past, the answer was to <code class="highlighter-rouge">--include-symbols</code> when building your Nuget pacakge. This will create <em>two</em> Nuget packages, one with the <code class="highlighter-rouge">pdb</code> files and one without. Up until a few years ago, you could publish both of these together to Nuget, but then that changed and now you have to publish the symbols package to a different server with a different API key and a different command. It becomes a real headache, especially because of the inconsistent and out of date documentation. Hence why I have included it in this guide; I either need to tell you how to publish symbols from within the pipeline or tell you how to avoid it.</p> <p><a href="https://github.com/dotnet/sourcelink">SourceLink</a> to the rescue. SourceLink provides a way to link your package to a specific commit on, say, GitHub or elsewhere. I do recommend using SourceLink as it does so much more than just give you the PDB file - but even if you can’t or won’t, there is a gem hidden in the documentation, namely this line to add to your <code class="highlighter-rouge">.csproj</code>:</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;AllowedOutputExtensionsInPackageBuildOutputFolder&gt;</span>
  $(AllowedOutputExtensionsInPackageBuildOutputFolder);.pdb
<span class="nt">&lt;/AllowedOutputExtensionsInPackageBuildOutputFolder&gt;</span>
</code></pre></div></div> <p>What this will do is include the <code class="highlighter-rouge">pdb</code> file in your main Nuget package, meaning you don’t need a separate symbols package at all. Of course, using the full SourceLink is much better. Incidentally, this also works for private repos without sharing the source publicly.</p> <h2 id="variables">Variables</h2> <p>When you are looking at the documentation for Azure DevOps there are lists of variables scattered in different places. You will probably also find that the same variable in some context is referred to as Build.BuildId and in another as BUILD_BUILDID etc. Sometimes you have to reference it as %BUILD_BUILDID%, other times as $(Build.BuildId) and yet other times as $(Build_BuildID). It does sort of make sense, but as a good starting point, when designing your YAML file, I recommend adding this task somewhere:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="s">set</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">show variables</span>
</code></pre></div></div> <p>It just dumps all the environment variables to the log, so you can have a look through to see what is actually available for you to reference.</p> <h2 id="setting-up-a-pipeline">Setting up a pipeline.</h2> <p>The easiest way to set up a build pipeline on Azure DevOps from GitHub is to add the <a href="https://github.com/marketplace/azure-pipelines">Azure Pipelines</a> GitHub App to your Github account. When you connect it to a repository, it will walk you through setting up a default pipeline; just choose the “empty” option. This pipeline will save a YAML file into your repository and will set up two triggers. One is a simple trigger to run the pipeline for any commit on any branch, the other is a specific integration into Pull Requests; essentially any pull request will be run through the pipeline and if it fails it will block the PR from being merged.</p> <p>This is the YAML file I ended up:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This only runs for master and develop. Plus a seperate trigger is run for PR validation. This means commits to branches not in a PR won't get tested. Choices, choices...</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">NewOrbit.NewOrbit.AddOne - build and test</span>
<span class="na">trigger</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">master</span>
  <span class="pi">-</span> <span class="s">develop</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">buildConfiguration</span><span class="pi">:</span> <span class="s">Release</span>

<span class="na">pool</span><span class="pi">:</span>
  <span class="na">vmImage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">vs2017-win2016'</span>

<span class="na">steps</span><span class="pi">:</span>

<span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="s">set</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">show variables</span>

<span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="s">dotnet restore</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">dotnet restore</span>

<span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="s">dotnet build --configuration $(buildConfiguration) --no-restore</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">build</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">DotNetCoreCLI@2</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">test</span>
    <span class="na">projects</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/*tests/*.csproj'</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">--configuration</span><span class="nv"> </span><span class="s">$(buildConfiguration)'</span>

<span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="s">dotnet pack --configuration $(buildConfiguration) --no-build --output %Build_ArtifactStagingDirectory%</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), or(eq(variables['Build.SourceBranchName'], 'master'),eq(variables['Build.SourceBranchName'], 'develop')))</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">pack</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">NuGetCommand@2</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">publish</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), or(eq(variables['Build.SourceBranchName'], 'master'),eq(variables['Build.SourceBranchName'], 'develop')))</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">push</span>
    <span class="na">nuGetFeedType</span><span class="pi">:</span> <span class="s">external</span>
    <span class="na">publishFeedCredentials</span><span class="pi">:</span> <span class="s1">'</span><span class="s">NewOrbit</span><span class="nv"> </span><span class="s">MyGet</span><span class="nv"> </span><span class="s">Nuget'</span>
    <span class="na">packagesToPush</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Build.ArtifactStagingDirectory)/**/*.nupkg'</span>
</code></pre></div></div> <p>The <code class="highlighter-rouge">trigger</code> part limits this to only run on checkins to <code class="highlighter-rouge">develop</code> and <code class="highlighter-rouge">master</code> (note, some of the documentation has a more verbose syntax that seems to not work). The Pull Request trigger still works so all Pull Request and all commits into an open Pull Request will be run through this pipeline. But, for me, I don’t need CI to run on every commit on every feature branch. That’s just me - if you want the pipeline to run for every commit, just delete the <code class="highlighter-rouge">trigger</code> section altogether.</p> <p>The steps through restore and build should be obvious. The step after that uses a special Azure DevOps task to run the unit tests, which ensures that the results are reported in a nice way in the pipeline.</p> <p>The <code class="highlighter-rouge">script: dotnet pack</code> packs the Nuget package and outputs the package to a particular holding area. To be honest, I could probably forgo the <code class="highlighter-rouge">output</code> parameter but it helps to understand what is going on.<br /> The key thing here is the <code class="highlighter-rouge">condition</code> line. This will ensure that a Nuget package is <em>only</em> created if the build is of either the develop or the master branch. If you wanted to publish “beta” versions from <code class="highlighter-rouge">release/*</code> branches, it should be straight forward to extend the condition accordingly.<br /> Incidentally, there is an Azure DevOps task for creating the Nuget package but I couldn’t get it to work so used <code class="highlighter-rouge">dotnet pack</code> instead.</p> <p>The final task publishes the created nuget package to Nuget. In this case I am publishing it to Myget; In order to do this, you first need to go to your <em>project</em> in Azure DevOps, go to Project Settings and then select Service Connections (it’s well hidden). Then add a connection to Nuget or MyGet or whatever Nuget feed you want to publish to. You put the <em>name</em> of that service connection in the <code class="highlighter-rouge">publishFeedCredentials</code> property in the YAML file.</p> <p>if you wanted to publish packages from your develop branch to MyGet and the ones from Master to NuGet you can hopefully see how you can just duplicate the last task and change the <code class="highlighter-rouge">condition</code> statements to suit your needs.</p> <p><strong>NOTE</strong> There is a bug in Azure DevOps that may result in an error saying something like that your pipeline doesn’t have the right permissiom to use the service connection. It’s easy to fix by following the guidance <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/resources?view=vsts">here</a>.</p> <h2 id="approvals">Approvals</h2> <p>The approach described above will publish packages immediately. If you wanted, you can easily set it up so you have to manually approve the publish. In short, you need to replace the final publish task in the YAML above with a Publish Artifacts task.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">PublishBuildArtifacts@1</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">artifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">package'</span> 
</code></pre></div></div> <p>This will copy whatever is in the <code class="highlighter-rouge">%Build_ArtifactStagingDirectory%</code> directory (where we put the Nuget package before) and make it available as an artefact of the build. Once you run the pipeline, look at the build and you will see an Artefact. If you click on that, Azure DevOps will take you through a wizard to set up a release pipeline, which you can then use to add manual approval before you publish the package to Nuget.</p> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2018/10/03/publish-nuget-packages-with-azure-devops.html'; this.page.identifier = '/2018/10/03/publish-nuget-packages-with-azure-devops.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2018/10/03/publish-nuget-packages-with-azure-devops.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a href="https://github.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a href="https://www.linkedin.com/in/flytzen/" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2019 </div> </div> </footer> </body> </html>
