<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Windows Workflow Foundation 4 State Machine and tight loops</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="I am a big fan of Windows Workflow. Sure, there are a lot of barriers to get started and a lot of idiosyncrasies, but once you get past that, it can do an awful lot to help with building large, complex systems. One issue I have come across recently is..." /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Windows Workflow Foundation 4 State Machine and tight loops</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2012-04-25T22:23:00+01:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">25 Apr 2012</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#WWF" class="icon__txt tag">WWF</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> <p>I am a big fan of Windows Workflow. Sure, there are a lot of barriers to get started and a lot of idiosyncrasies, but once you get past that, it can do an awful lot to help with building large, complex systems. </p><p>One issue I have come across recently is that workflows using the <a href="http://msdn.microsoft.com/en-us/library/ee264171.aspx" target="_blank">State Machine</a> can easily go into a tight loop that will use up all the CPU on your web server if you are hosting it in IIS. You may experience that your web server goes to 100% CPU usage (w3wp.exe) for a period of time but there is no information in your logs to find out what is going on.</p><p>It turns out that if you have an empty trigger on a transition but the condition blocks it, WWF may go into a tight loop.</p><h2></h2><h4>A simple example</h4><p>A simple scenario for this might be that you are designing the workflow and you put in a transition “to be done later” and you just set the condition to False to stop it firing.</p><p><a href="http://lh3.ggpht.com/-OrhHx6soNAI/T5hrMPZ6mLI/AAAAAAAAANw/kS--TKBguBU/s1600-h/SimplestStateMachine%25255B34%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="SimplestStateMachine" border="0" alt="SimplestStateMachine" src="http://lh4.ggpht.com/-b4hsBQZSW_g/T5hrNHvvhpI/AAAAAAAAAN4/_SpOCmLjUQY/SimplestStateMachine_thumb%25255B32%25255D.png?imgmax=800" width="322" height="354" /></a><a href="http://lh4.ggpht.com/-2_11DHU9gs8/T5hrN16kafI/AAAAAAAAAOA/F6AVzvPAzrs/s1600-h/SimpleFalseTrigger%25255B5%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="SimpleFalseTrigger" border="0" alt="SimpleFalseTrigger" src="http://lh5.ggpht.com/-2t07C4-XhuQ/T5hrO98J8dI/AAAAAAAAAOE/Bdss68hvIz0/SimpleFalseTrigger_thumb%25255B3%25255D.png?imgmax=800" width="300" height="354" /></a></p><p>In the above simple example, the transition from T1 to T2 has no trigger but the Condition is set to False. You’d think that this would just make the transition never fire, but what actually happens is that the workflow goes into a tight loop where it is continually testing the condition, thus eating up all the CPU on your web server and with nothing in the log to show for it. Note that it is possible that if you run this very simple example it may not actually cause the tight loop – it can sometimes depend on other factors.</p><h4>A more realistic example</h4><p>In practice, the above example is very simplistic, a more realistic example is something like this:</p><p><a href="http://lh5.ggpht.com/-LMzxIqtrT9I/T5hrPXC_FgI/AAAAAAAAAOM/qHZxkACFegc/s1600-h/StateMachine%25255B3%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="StateMachine" border="0" alt="StateMachine" src="http://lh6.ggpht.com/-LJPO3yB5cD4/T5hrQBk59TI/AAAAAAAAAOU/LhcTPSkXJ6Y/StateMachine_thumb%25255B1%25255D.png?imgmax=800" width="237" height="354" /></a><a href="http://lh5.ggpht.com/-2786o3v0bvY/T5hrQxNNoEI/AAAAAAAAAOc/23D8TS7_Vr8/s1600-h/trigger2%25255B3%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="trigger2" border="0" alt="trigger2" src="http://lh5.ggpht.com/-Ur4r-c0lJ00/T5hrRvZy6xI/AAAAAAAAAOk/WAcrzbHYlGk/trigger2_thumb%25255B1%25255D.png?imgmax=800" width="303" height="354" /></a></p><p>In the above example, the idea is that you have a workflow that needs to wait for a number of documents to arrive into the system and when they have all arrived, do something. In the example, we have a “waiting for docs” state. Every time that state is entered, it checks how many documents are still pending and writes that to a variable. The “Doc Received” transition in this example is a an external event, for example a WCF ReceiveAndSendReply. The trigger, in turn, checks the variable and moves on once it gets to zero. So, the idea is that each time a document is received, the workflow is prodded and recalculates the number of pending docs and once the count reaches zero, move on. Alas, this will cause a tight loop and consume all your CPU.</p><p>The above example can be implemented like this to avoid the problem:</p><p><a href="http://lh3.ggpht.com/-CpqhEBtlvIw/T5hrSUGl7zI/AAAAAAAAAOs/Vqx6YgZVoWo/s1600-h/StateMachine2%25255B3%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="StateMachine2" border="0" alt="StateMachine2" src="http://lh6.ggpht.com/-RUVxu8NbogU/T5hrTWl0JOI/AAAAAAAAAO0/2BudRAsqkZo/StateMachine2_thumb%25255B1%25255D.png?imgmax=800" width="400" height="354" /></a></p><p>In essence, the arrival of a new document moves to a new state called Interim. That has two transitions coming out from it, both with empty triggers. However, one of them will be true and the other will be false so they will both be evaluated but the workflow will then either move back to “Waiting for docs” or on to “All docs received”, thus avoiding a tight loop.</p><h4></h4><h4>The root cause</h4><p>I hesitate to call this a bug. In essence, as long as a state machine is sitting in a state, it will continually test all trigger-less transitions. I suspect this is by design, though I don’t like it; I would rather that the trigger-less transitions were only tested once, when the state had finished its “entry”. If I did want a state to continually check all the triggers, it would be trivial for me to then add another transition that just uses a delay to loop back to the same state, but I would then be in control of how “tight” I would allow the loop to be.</p><h4>How to identify the problem</h4><p>The annoying thing with this problem is that you are unlikely to notice this when you are developing on your nice multi-core development machine; This workflow will just tie up one core but it will actually work functionally correctly. So, it isn’t until you deploy to your webserver and you have many of these workflows (or use single-core server instances) that everything falls apart.</p><p>If you are experiencing this 100% CPU usage, try <a href="http://msdn.microsoft.com/en-us/library/ee518966.aspx" target="_blank">enabling tracing</a> in your workflow by putting this in your web.config:</p><pre class="prettyprint">&lt;system.diagnostics&gt;<br />  &lt;sources&gt;<br />    &lt;source name=&quot;System.Activities&quot; switchValue=&quot;Information&quot;&gt;<br />      &lt;listeners&gt;<br />        &lt;add name=&quot;textListener&quot; type=&quot;System.Diagnostics.TextWriterTraceListener&quot; initializeData=&quot;WorkflowTraceLog.txt&quot; traceOutputOptions=&quot;ProcessId, DateTime&quot; /&gt;<br />        &lt;remove name=&quot;Default&quot; /&gt;<br />      &lt;/listeners&gt;<br />    &lt;/source&gt;<br />  &lt;/sources&gt;<br />  &lt;trace autoflush=&quot;true&quot; indentsize=&quot;4&quot; /&gt;<br />&lt;/system.diagnostics&gt;</pre><br /><br /><br /><br /><p><strong>Top tip</strong>: If you are working with state machines in Windows Workflow Foundation 4, I suggest you enable this tracing on your development box and just keep an eye on the size of the log file and delete it occasionally. If it all of a sudden gets very big, chances are you have a tight loop somewhere.</p> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2012/04/25/windows-workflow-foundation-4-state.html'; this.page.identifier = '/2012/04/25/windows-workflow-foundation-4-state.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2012/04/25/windows-workflow-foundation-4-state.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a href="https://github.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a href="https://www.linkedin.com/in/flytzen/" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> <a rel="me" href="https://hachyderm.io/@flytzen" target="_blank"> <svg style="width:24px;height:24px" fill="currentColor" viewBox="0 0 24 24" class="social-icon"> <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2022 </div> </div> </footer> </body> </html>
