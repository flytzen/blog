<!DOCTYPE html>
<html lang="en">

  <head>
  <title>Frans' Randomness - Entity Framework Code First, Inheritance and ComplexType</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frans' Randomness" />
  
  <meta name="description" content="In one of the applications we are working on, we have a pretty complex inheritance hierarchy which is mapped to SQL Server using Entity Framework 4.3 using Code First. We noticed that when selecting from the base type just on ID we had terrible performance. Some investigation revealed that the..." />
</head>


  <body>

    <header class="site-header" role="banner">
  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/">Frans&#39; Randomness</a>
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/talks">Talks</a>
          <a class="page-link" href="/blog">Blog</a>
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Entity Framework Code First, Inheritance and ComplexType</h1>
    <div class="post-meta">
      <div class="authorandtime">
        <time class="dt-published" datetime="2012-02-25T15:00:00+00:00" itemprop="datePublished">
          
          Feb 25, 2012
        </time>
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Frans Lytzen</span></span>
        
      </div>
      <div class="post-tags">
        
        <a href="/tags/#EntityFramework">EntityFramework</a>
        
        
      </div>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    In one of the applications we are working on, we have a pretty complex inheritance hierarchy which is mapped to SQL Server using Entity Framework 4.3 using Code First. We noticed that when selecting from the base type just on ID we had terrible performance. Some investigation revealed that the simple select-by-ID generated a SQL Statement that was 360,000 characters long. Generating the SQL statement took 1.5s, causing serious performance issues. Quite a lot of investigation revealed that Code First and Complex Types really don’t play well together. It is entirely possible to place a single property on a single class and massively decrease performance of your solution without it being at all obvious what is happening.<br />I don’t think this is necessarily a fault with Entity Framework nor do I pretend to fully understand what is happening, but here is a walk through that will show the issue. Note, for background reference on inheritance handling in EF Code First, I strongly recommend reading Morteza Manavi’s <a href="http://weblogs.asp.net/manavi/archive/2010/12/24/inheritance-mapping-strategies-with-entity-framework-code-first-ctp5-part-1-table-per-hierarchy-tph.aspx">series on the subject</a>.<br /><h4>When it works well</h4>If we run this code;<br /><pre class="prettyprint">class Program<br />{<br />    static void Main(string[] args)<br />    {<br />        Database.SetInitializer&lt;MyDb&gt;(new DropCreateDatabaseAlways&lt;MyDb&gt;());<br /><br />        var db = new MyDb();<br />        var t = db.Fruits.FirstOrDefault(f =&gt; f.ID == 1);<br />    }<br />}<br /><br />class MyDb : DbContext<br />{<br />    public DbSet&lt;Fruit&gt; Fruits { get; set; }<br />}<br /><br />abstract class Fruit<br />{<br />    public int ID { get; set; }<br />}<br /><br />class Apple : Fruit<br />{<br />    public int PipCount { get; set; }<br />}<br /><br />class Orange : Fruit<br />{<br />    public int Oranginess { get; set; }<br />}</pre>This SQL is generated: <br /><pre class="prettyprint">SELECT TOP (1) <br />[Extent1].[Discriminator] AS [Discriminator], <br />[Extent1].[ID] AS [ID], <br />[Extent1].[PipCount] AS [PipCount], <br />[Extent1].[Oranginess] AS [Oranginess]<br />FROM [dbo].[Fruits] AS [Extent1]<br />WHERE ([Extent1].[Discriminator] IN ('Apple','Orange')) AND (1 = [Extent1].[ID])</pre>That’s pretty neat; We get all the properties for all the subclasses in a neat way.<br /><h4>When it gets a little weird</h4>When we add a property to a sub class which is a Complex Type then we start having slightly strange results. If we change the class structure to this, for example;<br /><pre class="prettyprint">abstract class Fruit<br />{<br />    public int ID { get; set; }<br />}<br /><br />class Apple : Fruit<br />{<br />    public int PipCount { get; set; }<br />}<br /><br />class Orange : Fruit<br />{<br />    public int Oranginess { get; set; }<br />    public Nutrition Nutrition { get; set; }<br />}<br /><br />[ComplexType]<br />class Nutrition<br />{<br />    public int Calories { get; set; }<br />}</pre>We then get this SQL generated;<br /><pre class="prettyprint">SELECT <br />[Limit1].[Discriminator] AS [Discriminator], <br />[Limit1].[ID] AS [ID], <br />[Limit1].[PipCount] AS [PipCount], <br />[Limit1].[Oranginess] AS [Oranginess], <br />[Limit1].[C1] AS [C1]<br />FROM ( SELECT TOP (1) <br />    [Extent1].[ID] AS [ID], <br />    [Extent1].[PipCount] AS [PipCount], <br />    [Extent1].[Oranginess] AS [Oranginess], <br />    [Extent1].[Discriminator] AS [Discriminator], <br />    CASE WHEN ([Extent1].[Discriminator] = 'Orange') THEN [Extent1].[Nutrition_Calories] END AS [C1]<br />    FROM [dbo].[Fruits] AS [Extent1]<br />    WHERE ([Extent1].[Discriminator] IN ('Apple','Orange')) AND (1 = [Extent1].[ID])<br />)  AS [Limit1]</pre>The structure of the statement is a bit weird, but the key thing to note is the line<br /><pre class="prettyprint">CASE WHEN ([Extent1].[Discriminator] = 'Orange') THEN [Extent1].[Nutrition_Calories] END AS [C1]</pre>EF is starting to use Case statements to choose what to select from SQL, depending on the sub class. If you had more sub-classes then this would start getting bigger. Still, it’s something you can live with.<br /><h4>When it gets bad</h4>The real problems start when we use a complex type on an intermediate class as in this example:<br /><pre class="prettyprint">abstract class Fruit<br />{<br />    public int ID { get; set; }<br />}<br /><br />class Apple : Fruit<br />{<br />    public int PipCount { get; set; }<br />}<br /><br />abstract class Citrus : Fruit<br />{<br />    public Nutrition Nutrition { get; set; }<br />}<br /><br />class Orange : Citrus<br />{<br />    public int Oranginess { get; set; }<br />}<br /><br />class Clementine : Citrus<br />{<br />    public int Sweetness { get; set; }<br />}<br /><br />[ComplexType]<br />class Nutrition<br />{<br />    public int Calories { get; set; }<br />}</pre>What we have is an intermediate “Citrus” class, which inherits from Fruit and which has children. That generates this SQL:<br /><pre class="prettyprint">SELECT <br />[Limit1].[C1] AS [C1], <br />[Limit1].[ID] AS [ID], <br />[Limit1].[C2] AS [C2], <br />[Limit1].[C3] AS [C3], <br />[Limit1].[C4] AS [C4], <br />[Limit1].[C5] AS [C5]<br />FROM ( SELECT TOP (1) <br />    [Extent1].[ID] AS [ID], <br />    CASE WHEN ([Extent1].[Discriminator] = 'Apple') THEN '0X0X' <br />        WHEN ([Extent1].[Discriminator] = 'Orange') THEN '0X1X0X' ELSE '0X1X1X' END AS [C1], <br />    CASE WHEN ([Extent1].[Discriminator] = 'Apple') THEN [Extent1].[PipCount] <br />        WHEN ([Extent1].[Discriminator] = 'Orange') THEN CAST(NULL AS int) END AS [C2], <br />    CASE WHEN ([Extent1].[Discriminator] = 'Apple') THEN CAST(NULL AS int) <br />            WHEN ([Extent1].[Discriminator] = 'Orange') THEN <br />                CASE WHEN (((CASE WHEN ([Extent1].[Discriminator] = 'Orange') THEN cast(1 as bit) <br />                ELSE cast(0 as bit) END) = 1) <br />                OR ((CASE WHEN ([Extent1].[Discriminator] = 'Clementine') THEN cast(1 as bit) <br />                ELSE cast(0 as bit) END) = 1)) THEN [Extent1].[Nutrition_Calories] END <br />                WHEN (((CASE WHEN ([Extent1].[Discriminator] = 'Orange') <br />                THEN cast(1 as bit) ELSE cast(0 as bit) END) = 1) OR <br />                ((CASE WHEN ([Extent1].[Discriminator] = 'Clementine') THEN cast(1 as bit) <br />                ELSE cast(0 as bit) END) = 1)) THEN [Extent1].[Nutrition_Calories] END AS [C3], <br />    CASE WHEN ([Extent1].[Discriminator] = 'Apple') THEN CAST(NULL AS int) <br />        WHEN ([Extent1].[Discriminator] = 'Orange') THEN [Extent1].[Oranginess] END AS [C4], <br />    CASE WHEN ([Extent1].[Discriminator] = 'Apple') THEN CAST(NULL AS int) <br />        WHEN ([Extent1].[Discriminator] = 'Orange') THEN CAST(NULL AS int) ELSE [Extent1].[Sweetness] END AS [C5]<br />    FROM [dbo].[Fruits] AS [Extent1]<br />    WHERE ([Extent1].[Discriminator] IN ('Apple','Orange','Clementine')) AND (1 = [Extent1].[ID])<br />)  AS [Limit1]</pre>As far as I can tell, adding that ComplexType property to the intermediate class causes EF to pursue a strategy in which every single property from every single class other than the root class is selected using CASE clauses. From what I have read, this code looks like it is related to some strategies for performance optimisation with table-per-concrete-type.<br />Now, the above hierarchy is <em>very</em> simple- you can probably imagine what happens when you have a complex class structure.<br />Fixing this problem is a matter of either moving the complex type to the base class or change it to be a navigation property.<br />Microsoft Connect issue <a href="https://connect.microsoft.com/data/feedback/details/726610/complextype-propery-on-intermediate-class-in-inheritance-chain-causes-extremely-verbose-sql#details" target="_blank">here</a>
  </div>

  
    

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2012/02/25/entity-framework-code-first-inheritance.html';
      this.page.identifier = 'http://localhost:4000/2012/02/25/entity-framework-code-first-inheritance.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://flytzen.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  

  <a class="u-url" href="/2012/02/25/entity-framework-code-first-inheritance.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Frans&#39; Randomness</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Frans Lytzen
            </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">flytzen</span></a></li>
  
  <li><a href="https://www.twitter.com/flytzen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">flytzen</span></a></li>
  
  
  
</ul>

      </div>

      <div class="footer-col footer-col-3">
        <p>My very infrequent thoughts on the world of software development</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
