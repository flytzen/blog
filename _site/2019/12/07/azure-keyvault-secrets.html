<!DOCTYPE html> <html lang="en"> <head> <title>Frans' Randomness - Azure Key Vault Secrets</title> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="format-detection" content="telephone=no" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/assets/main.css?v=20180627"> <link type="application/atom+xml" rel="alternate" href="https://www.lytzen.name/feed.xml" title="Frans' Randomness" /> <meta name="description" content="Use Azure Key Vault to safely store secrets and passwords in Azure" /> </head> <body> <header class="header" role="banner"> <div class="wrapper"> <a class="header__title h3" rel="author" href="/">Frans&#39; Randomness</a> <nav class="header__nav"> <a class="header__nav-link" href="/talks">Talks</a> <a class="header__nav-link" href="/blog">Blog</a> </nav> </div> </header> <main class="page-content" aria-label="Content"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post__header"> <div class="wrapper"> <h1 class="post__title" itemprop="name headline">Azure Key Vault Secrets</h1> <div class="post__meta"> <div class="post__author-time"> <span class="post__author" itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Author <strong>Frans Lytzen</strong></span> </span> <time class="post__date-time dt-published" datetime="2019-12-07T00:00:00+00:00" itemprop="datePublished"> <div class="date-time icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1" /> </svg> <span class="icon__txt">07 Dec 2019</span> </div> </time> </div> <div class="tags icon__item"> <svg class="icon__gfx" style="width:24px;height:24px" viewBox="0 0 24 24"> <path d="M5.5,9A1.5,1.5 0 0,0 7,7.5A1.5,1.5 0 0,0 5.5,6A1.5,1.5 0 0,0 4,7.5A1.5,1.5 0 0,0 5.5,9M17.41,11.58C17.77,11.94 18,12.44 18,13C18,13.55 17.78,14.05 17.41,14.41L12.41,19.41C12.05,19.77 11.55,20 11,20C10.45,20 9.95,19.78 9.58,19.41L2.59,12.42C2.22,12.05 2,11.55 2,11V6C2,4.89 2.89,4 4,4H9C9.55,4 10.05,4.22 10.41,4.58L17.41,11.58M13.54,5.71L14.54,4.71L21.41,11.58C21.78,11.94 22,12.45 22,13C22,13.55 21.78,14.05 21.42,14.41L16.04,19.79L15.04,18.79L20.75,13L13.54,5.71Z" /> </svg> <a href="/tags/#Azure" class="icon__txt tag">Azure</a> <a href="/tags/#Security" class="icon__txt tag">Security</a> </div> </div> </div> </header> <div class="wrapper"> <div class="post__content e-content" itemprop="articleBody"> <p><a href="https://azureadventcalendar.com/">Azure Advent Calendar 2019</a> is a great initiative to generate and share a bunch of Azure content. I was fortunate enough to be able to create a video about Azure Key Vault for the Advent Calendar. Specifically, this video focuses on storing <em>secrets</em> in Azure Key Vault.</p> <iframe width="560" height="315" src="https://www.youtube.com/embed/SIA3pleuqfQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> <p>Please check out all the <a href="https://www.youtube.com/channel/UCJL9wCcmeMBbah4J0uOWIPg">other great content and subscribe to the channel</a>.</p> <h1 id="content">Content</h1> <p>The broad outline of the video is as follows:</p> <h2 id="what-is-azure-key-vault">What is Azure Key Vault?</h2> <p>Azure Key Vault provides the following, quite separate, areas of functionality:</p> <ul> <li>Secrets: Safe place to store passwords and other secrets</li> <li>Keys / Cryptography: Public/Private key encryption</li> <li>Certificate Store: Safe place to store X509 certificates</li> <li>Storage Account key rotation: Essentially a wrapper around “Secrets” to help you manage and rotate you Azure Storage Account keys.</li> </ul> <h2 id="azure-key-vault-secrets">Azure Key Vault Secrets</h2> <ul> <li>Store and retrieve secrets</li> <li>Fine-grained access control <ul> <li>For example, write-only access to a user, read-only access to an app</li> </ul> </li> <li>Auth is easy with Managed Identity</li> <li>Store multiple versions with stop/start dates etc <ul> <li>The dates are advisory and your code has to decide whether to read and use them</li> <li>Uniquely reference specific versions</li> </ul> </li> </ul> <h2 id="before-you-start-with-the-examples">Before you start with the examples</h2> <p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install the Azure CLI </a><br /> <em>Note: I use the PowerShell line continuation character below - if you run this in bash you need to change that</em></p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az login
az account set --subscription xxxx
az configure --defaults location=westeurope group=fl-test-keyvault
az group create --name fl-test-keyvault
</code></pre></div></div> <h2 id="create-a-key-vault">Create a Key Vault</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az keyvault create --name fl-test
</code></pre></div></div> <h2 id="give-read-and-write-permissions-to-a-user">Give read and write permissions to a user</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az keyvault set-policy `
    --name fl-test `
    --upn "flytzen@neworbit.co.uk" `
    --secret-permissions get, list, set  
</code></pre></div></div> <p>In the real world, a consuming application should not have “set” and an admin shouldn’t have get</p> <h2 id="add-a-secret">Add a secret</h2> <p><em>You can do this in the portal as well - and in code of course</em></p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az keyvault secret set `
    --name supersecretpassword `
    --vault-name fl-test `
    --value ohmyworditssosecret `
    --not-before 2019-12-03T14:30:25z `
    --expires 2019-12-24T23:59:59z `
    --disabled false `
    --output table
</code></pre></div></div> <p>Note that the “disabled” flag is enforced; most operations are blocked on a disabled secret. However, the nbf and expiry are for information and it’s up to you to read them and act on them This is <em>different</em> for keys!</p> <h2 id="set-up-a-console-app-to-read-the-secret">Set up a console app to read the secret</h2> <p><em>Note: New packages have just come out but they have <a href="https://github.com/Azure/azure-sdk-for-net/issues/8934">less intuitive auth</a> - for now</em></p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new console -n ShowSecrets 
cd ShowSecrets 
dotnet add package Microsoft.Azure.KeyVault
dotnet add package Microsoft.Azure.Services.AppAuthentication
code .
</code></pre></div></div> <h2 id="fields">Fields</h2> <p>Add the following to the top of the Main class:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">keyVaultUrl</span> <span class="p">=</span> <span class="s">"https://fl-test.vault.azure.net"</span><span class="p">;</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">supersecretname</span> <span class="p">=</span> <span class="s">"supersecretpassword"</span><span class="p">;</span>
</code></pre></div></div> <h2 id="simple-program-to-retrieve-secret">Simple program to retrieve secret</h2> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">tokenProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AzureServiceTokenProvider</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">keyVaultClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">KeyVaultClient</span><span class="p">(</span>
               <span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">.</span><span class="nf">AuthenticationCallback</span><span class="p">(</span><span class="n">tokenProvider</span><span class="p">.</span><span class="n">KeyVaultTokenCallback</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">secretValue</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyVaultClient</span><span class="p">.</span><span class="nf">GetSecretAsync</span><span class="p">(</span><span class="n">keyVaultUrl</span><span class="p">,</span> <span class="n">supersecretname</span><span class="p">);</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">secretValue</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div> <h2 id="change-the-secret-in-the-cli">Change the secret in the CLI</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az keyvault secret set `
    --name supersecretpassword `
    --vault-name fl-test `
    --value OXFORD `
    --not-before 2019-12-24T14:30:25z `
    --expires 2019-12-31T23:59:59z `
    --disabled false
</code></pre></div></div> <h2 id="see-all-the-versions">See all the versions</h2> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">tokenProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AzureServiceTokenProvider</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">keyVaultClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">KeyVaultClient</span><span class="p">(</span>
                 <span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">.</span><span class="nf">AuthenticationCallback</span><span class="p">(</span><span class="n">tokenProvider</span><span class="p">.</span><span class="n">KeyVaultTokenCallback</span><span class="p">));</span>
    
    <span class="kt">var</span> <span class="n">secretVersions</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyVaultClient</span><span class="p">.</span><span class="nf">GetSecretVersionsAsync</span><span class="p">(</span><span class="n">keyVaultUrl</span><span class="p">,</span> <span class="n">supersecretname</span><span class="p">);</span>

    <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">secretVersion</span> <span class="k">in</span> <span class="n">secretVersions</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">secretVersionValue</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyVaultClient</span><span class="p">.</span><span class="nf">GetSecretAsync</span><span class="p">(</span><span class="n">secretVersion</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">secretVersion</span><span class="p">.</span><span class="n">Identifier</span><span class="p">}</span><span class="s"> | </span><span class="p">{</span><span class="n">secretVersion</span><span class="p">.</span><span class="n">Attributes</span><span class="p">.</span><span class="n">Enabled</span><span class="p">}</span><span class="s"> | </span><span class="p">{</span><span class="n">secretVersion</span><span class="p">.</span><span class="n">Attributes</span><span class="p">.</span><span class="n">NotBefore</span><span class="p">}</span><span class="s"> | </span><span class="p">{</span><span class="n">secretVersion</span><span class="p">.</span><span class="n">Attributes</span><span class="p">.</span><span class="n">Expires</span><span class="p">}</span><span class="s"> | </span><span class="p">{</span><span class="n">secretVersionValue</span><span class="p">.</span><span class="n">Value</span><span class="p">}</span><span class="s">"</span> <span class="p">);</span>
    <span class="p">}</span>  
<span class="p">}</span>
</code></pre></div></div> <h2 id="try-it-in-aspnet-core">Try it in ASP.Net Core</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new mvc
dotnet add package Microsoft.Azure.KeyVault
dotnet add package Microsoft.Azure.Services.AppAuthentication
dotnet add package Microsoft.Extensions.Configuration.AzureKeyVault
</code></pre></div></div> <p>In <code class="highlighter-rouge">program.cs</code> change:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IHostBuilder</span> <span class="nf">CreateHostBuilder</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="n">Host</span><span class="p">.</span><span class="nf">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">ConfigureWebHostDefaults</span><span class="p">(</span><span class="n">webBuilder</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">webBuilder</span><span class="p">.</span><span class="n">UseStartup</span><span class="p">&lt;</span><span class="n">Startup</span><span class="p">&gt;();</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nf">ConfigureAppConfiguration</span><span class="p">((</span><span class="n">context</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">config</span><span class="p">.</span><span class="nf">AddAzureKeyVault</span><span class="p">(</span><span class="s">"https://fl-test.vault.azure.net"</span><span class="p">,</span>
                                    <span class="k">new</span> <span class="nf">KeyVaultClient</span><span class="p">(</span>
                                        <span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">.</span><span class="nf">AuthenticationCallback</span><span class="p">(</span>
                                            <span class="k">new</span> <span class="nf">AzureServiceTokenProvider</span><span class="p">().</span><span class="n">KeyVaultTokenCallback</span><span class="p">)),</span>
                                    <span class="k">new</span> <span class="nf">DefaultKeyVaultSecretManager</span><span class="p">());</span>
        <span class="p">});</span>

</code></pre></div></div> <p>In <code class="highlighter-rouge">Home/index.cshtml</code> add:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@{
   string myPassword = Configuration["supersecretpassword"];
}

&lt;h2&gt;Retrieved from Key Vault:&lt;/h2&gt;
&lt;h1&gt;@myPassword&lt;/h1&gt;
</code></pre></div></div> <p><em>Note: Directly injecting and using config in the view like this is a <strong>bad</strong> idea. Don’t do this in the real world please.</em></p> <h1 id="do-it-on-azure">Do it on Azure</h1> <p>This part is more about deploying to Azure and setting up Managed Identity</p> <h2 id="set-up-git-on-the-repository-to-make-it-easy">Set up git on the repository to make it easy</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git init 
echo "bin/" | out-file .gitignore -encoding utf8 
echo "obj/" | out-file .gitignore -encoding utf8 -append 
git add -A
git commit -m "Initial commit"
</code></pre></div></div> <h2 id="create-a-web-app-slot">Create a web app slot</h2> <p><em>Note: this won’t work in PowerShell because of the pipe symbol in “DOTNETCORE|3.0”! You need to run the <code class="highlighter-rouge">webapp create</code> command in a command prompt or bash</em></p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az appservice plan create --name fl-test-keyvault-secrets --sku S1 --is-linux  -o json
az webapp create --name fl-test-keyvault-secrets --plan fl-test-keyvault-secrets --runtime "DOTNETCORE|3.0" --deployment-local-git -o json
</code></pre></div></div> <h2 id="enable-managed-identity-and-give-it-access-to-the-key-vault">Enable Managed Identity and give it access to the key vault</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az webapp identity assign --name fl-test-keyvault-secrets

az keyvault set-policy `
    --name fl-test `
    --object-id f0e46c32-3492-407c-b31f-3e137e378ea7 `
    --secret-permissions get, list  
</code></pre></div></div> <h2 id="add-azure-as-a-git-remote-so-we-can-push-to-it">Add azure as a git remote so we can push to it</h2> <p>The first line gets the publishing username and password for this webapp, which you’ll be prompted for when you <code class="highlighter-rouge">git push</code>.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az webapp deployment list-publishing-credentials --name fl-test-keyvault-secrets -o json
git remote add azure https://fl-test-keyvault-secrets.scm.azurewebsites.net/fl-test-keyvault-secrets.git
git push -u azure master
</code></pre></div></div> <h2 id="check-the-result">Check the result</h2> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az webapp browse --name fl-test-keyvault-secrets
</code></pre></div></div> <p><a href="https://azureadventcalendar.com/"><img src="/assets/Advent-Calendar7.jpg" alt="Azure Advent Calendar logo" /></a></p> </div> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = 'https://www.lytzen.name/2019/12/07/azure-keyvault-secrets.html'; this.page.identifier = '/2019/12/07/azure-keyvault-secrets.html'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://flytzen.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> <a class="u-url" href="/2019/12/07/azure-keyvault-secrets.html" hidden></a> </div> </article> </main> <footer class="footer"> <div class="wrapper"> <div class="social-links"> <a href="https://github.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /> </svg> </a> <a href="https://www.linkedin.com/in/flytzen/" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M21,21H17V14.25C17,13.19 15.81,12.31 14.75,12.31C13.69,12.31 13,13.19 13,14.25V21H9V9H13V11C13.66,9.93 15.36,9.24 16.5,9.24C19,9.24 21,11.28 21,13.75V21M7,21H3V9H7V21M5,3A2,2 0 0,1 7,5A2,2 0 0,1 5,7A2,2 0 0,1 3,5A2,2 0 0,1 5,3Z" /> </svg> </a> <a href="https://twitter.com/flytzen" target="_blank"> <svg style="width:24px;height:24px" viewBox="0 0 24 24" class="social-icon"> <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /> </svg> </a> </div> <div class="copyright"> &copy; Frans Lytzen 2022 </div> </div> </footer> </body> </html>
