---
layout: post
title: Auto publish Azure Web Jobs with ASP.Net Core RTM
date: '2016-08-26T10:36:00.000+01:00'
author: Frans Lytzen
tags: 
modified_time: '2016-08-26T10:37:10.033+01:00'
blogger_id: tag:blogger.com,1999:blog-8302357413081836531.post-681504718095303199
blogger_orig_url: http://blog.lytzen.name/2016/08/auto-publish-azure-web-jobs-with-aspnet.html
---

<i>This is an update of my <a href="http://blog.lytzen.name/2016/03/auto-deploy-azure-web-job-with-aspnet-5.html">original post</a> on how to do this with ASP.Net Core RC1</i><br />At the time of this writing, there is no tooling to auto publish Azure Web Jobs with an ASP.Net Core website. You can do it with old-style websites, but not yet the new ones. The tooling is highly likely to appear eventually, but as of right now you have to take a few steps to set it up yourself, which is what I describe in this post. For clarity, what I am describing works only with source control deploy (git etc),&nbsp;<i>not</i>&nbsp;with publishing from Visual Studio.<br /><br /><b>This information will eventually become obsolete, probably around the RTM of the ASP.Net Core Visual Studio tooling. If that has happened and I have not updated the post, please post a comment and I'll get on it.</b><br />Note that for very simple, self-contained web jobs, there may be a simpler approach (see&nbsp;<a href="http://stackoverflow.com/a/33291097/11534">http://stackoverflow.com/a/33291097/11534</a>&nbsp;for some thoughts). In this post I am catering for the scenario where your webjob references another project in your solution - though it'll work just as well if it doesn't.<br /><h3>In summary</h3><div>You have to use a custom deployment script and insert an action to&nbsp;<i>publish</i>&nbsp;your webjob to the path that Azure looks for webjobs in; App_Data/Jobs/Continuous for continuous jobs. Azure will automatically detect content in that folder and assume it's a webjob, so all we really have to do is make sure our webjob is copied there. And yes, it will happily overwrite a running webjob, the Kudu functionality handles that somehow.<br /><br />The reason we are&nbsp;<i>publishing,&nbsp;</i>using <i>dotnet publish</i>, is to ensure we get all the dependencies. It won't re-compile so it's just a copy operation.<br />If we had a very simple webjob that was self contained, you could just copy&nbsp;the files, as long as you added a&nbsp;<i>run.cmd</i>&nbsp;(see link above).<br /><br /></div><h3>In detail</h3><div>Prepare a site<br /><ol><li>Set up a solution with an ASP.Net 5 Web site and a webjob written as a ASP.Net 5 / Core console app.</li><li>Set up source control deploy to an Azure website. It shouldn't matter which type.</li><li>Wait for the initial deploy of the site.&nbsp;</li></ol><h4>Set up a custom deployment script</h4></div><div>In this example, we will download the deployment script that Azure has created. There are ways to also do this with the Azure CLI, but the generated script is not quite the same at this point in time - which may or may not matter.</div><div><ol><li>Get the auto generated script</li><ol><li>Log in to the web app console at https://[yoursite].scm.azurewebsites.net</li><li>Go to Tools - Download deployment script</li><li>Unzip the downloaded zip file to the root of your solution folder</li></ol><li>Modify your deploy.cmd file in the following ways<br /></li><ol><li>Add a line like this near the top - just to make it easier to check that your custom script is being used (whatever you put after echo will be output in the log file)<br /><pre class="prettyprint">echo CUSTOM SCRIPT Start<br /></pre></li><li>Near the middle of the file you will find a series of steps that are numbered. One of the steps will look like this;<br /><strong>NOTE: The indented lines will be on a single line, the line breaks are only added here for readability</strong><br /><pre class="prettyprint">:: 2. Build and publish<br />call :ExecuteCmd "%MSBUILD_PATH%" "%DEPLOYMENT_SOURCE%\MySolution.sln" <br />       /nologo <br />       /verbosity:m <br />       /p:deployOnBuild=True;<br />          AutoParameterizationWebConfigConnectionStrings=false;<br />          Configuration=Release;<br />          UseSharedCompilation=false;<br />          publishUrl="%DEPLOYMENT_TEMP%" <br />       %SCM_BUILD_ARGS%<br /><br /></pre></li><li>Below that insert these lines (updating the path with the actual path to your webjob in the solution)<br /><strong>NOTE: The indented lines need to put on a single line, the line breaks are only here for readability</strong><br /><pre class="prettyprint">:: 2.1 Publish webjobs<br />echo STARTING TO PUBLISH WEBJOBS<br />echo DEPLOYMENT_TEMP is %DEPLOYMENT_TEMP%<br />call :ExecuteCmd dotnet publish <br />       "%DEPLOYMENT_SOURCE%\src\MyWebJob\project.json" <br />         -o "%DEPLOYMENT_TEMP%\App_Data\Jobs\Continuous\MyWebJob" <br />       -c Release<br /></pre>If you have more than one web job, just add individual publish lines for each one</li></ol></ol></div><br /><h4>Check that it worked</h4><div>Push your changes and wait for Azure to deploy, then look at the webjobs in the Azure portal. You should see your job there. In case you don't, have a look at the publish log file to see if there are any errors in there.</div>