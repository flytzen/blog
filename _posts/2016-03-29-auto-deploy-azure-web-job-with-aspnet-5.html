---
layout: post
title: Auto deploy Azure Web Job with ASP.Net 5 and source control deploy
date: '2016-03-29T21:37:00.000+01:00'
author: Frans Lytzen
tags:
- azure
modified_time: '2016-08-26T10:40:51.833+01:00'
blogger_id: tag:blogger.com,1999:blog-8302357413081836531.post-3878489788050071666
blogger_orig_url: http://blog.lytzen.name/2016/03/auto-deploy-azure-web-job-with-aspnet-5.html
---

<h2>Update</h2>An updated version of this post that targets ASP.Net Core RTM <a href="http://blog.lytzen.name/2016/08/auto-publish-azure-web-jobs-with-aspnet.html">is now available</a>.<br /><br /><br /><br /><br /><br /><h2>The content below here refers to RC1 which is not supported on Azure</h2><div><br /></div><div><br /></div>At the time of this writing, there is no tooling to auto publish Azure Web Jobs with an ASP.Net 5 (DNX) website. You can do it with old-style websites, but not yet the new ones. The tooling is highly likely to appear as we get closer to release, but as of right now you have to take a few steps to set it up yourself, which is what I describe in this post. For clarity, what I am describing works only with source control deploy (git etc), <i>not</i>&nbsp;with publishing from Visual Studio.<br /><br /><b>This information will become obsolete nearer to the release of ASP.Net 5. If that has happened and I have not updated the post, please post a comment and I'll get on it.</b><br />Note that for very simple, self-contained web jobs, there may be a simpler approach (see&nbsp;<a href="http://stackoverflow.com/a/33291097/11534">http://stackoverflow.com/a/33291097/11534</a> for some thoughts). In this post I am catering for the scenario where your webjob references another project in your solution - though it'll work just as well if it doesn't.<br /><br /><h3>In summary</h3><div>You have to use a custom deployment script and insert an action to <i>publish</i>&nbsp;your webjob to the path that Azure looks for webjobs in; App_Data/Jobs/Continuous for continuous jobs. Azure will automatically pick up on content in that folder. And yes, it will happily overwrite a running webjob.<br /><br />The reason we are <i>publishing, </i>using DNU Publish, is to effectively build the web job and get all it's dependencies. Of course, once RC2 is out we'll probably have to change the syntax.<br />If we had a very simple webjob that was self contained, you could just copy&nbsp;the files, as long as you added a <i>run.cmd</i>&nbsp;(see link above).<br /><br /></div><h3>In detail</h3><div><a href="https://github.com/flytzen/AutoDeplyAzureWebJob">Full example on Github</a>.<br /><br /><h4>Prepare a site</h4><br /><ol><li>Set up a solution with an ASP.Net 5 Web site and a webjob written as a ASP.Net 5 / Core console app.</li><li>Set up source control deploy to an Azure website. It shouldn't matter which type.</li><li>Wait for the initial deploy of the site.&nbsp;</li></ol><br /><h4>Set up a custom deployment script</h4></div><div>In this example, we will download the deployment script that Azure has created. There are ways to also do this with the Azure CLI, but the generated script is not quite the same at this point in time - which may or may not matter.</div><div><ol><li>Get the auto generated script</li><ol><li>Log in to the web app console at https://[yoursite].scm.azurewebsites.net</li><li>Select Debug Console -&gt; Powershell</li><li>Navigate to site/deployments/tools</li><li>Download the file deploy.cmd to the root of your solution folder</li></ol><li>Create a file in the root of your solution folder called .deployment with the following content<br /><pre class="prettyprint">[config]<br />command = deploy.cmd<br /></pre></li><li>Modify your deploy.cmd file in the following ways</li><ol><li>Add a line like this near the top - just to make it easier to check that your custom script is being used (whatever you put after echo will be output in the log file)<br /><pre class="prettyprint">echo CUSTOM SCRIPT Start<br /></pre></li><li>Near the middle of the file you will find a series of steps that are numbered. One of the steps will look like this; <br /><strong>NOTE: The indented lines will be on a single line, the line breaks are only added here for readability</strong><br /><pre class="prettyprint">:: 4. Run DNU Bundle<br />call %DNX_RUNTIME%\bin\dnu publish<br />  "D:\home\site\repository\src\Web\project.json" <br />  --runtime %DNX_RUNTIME% <br />  --out "%DEPLOYMENT_TEMP%" <br />  %SCM_DNU_PUBLISH_OPTIONS%<br />IF !ERRORLEVEL! NEQ 0 goto error<br /></pre></li><li>Below that insert these lines (updating the path with the actual path to your webjob in the solution)<br /><strong>NOTE: The indented lines need to put on a single line, the line breaks are only here for readability</strong><br /><pre class="prettyprint">:: 4.1 build web job<br />echo Starting to build webjob<br />call %DNX_RUNTIME%\bin\dnu publish <br />  "D:\home\site\repository\src\MyWebJob\project.json" <br />  --runtime %DNX_RUNTIME% <br />  --out "%DEPLOYMENT_TEMP%\wwwroot\App_Data\Jobs\Continuous\MyWebJob" <br />  %SCM_DNU_PUBLISH_OPTIONS%<br />IF !ERRORLEVEL! NEQ 0 goto error</pre></li></ol></ol></div><br /><h4>Check that it worked</h4><div>Push your changes and wait for Azure to deploy, then look at the webjobs in the Azure portal. You should see your job there. In case you don't, have a look at the publish log file to see if there are any errors in there.</div><div><br /></div>