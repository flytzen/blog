---
layout: post
title: Continuous deployment to Azure Cloud Services
date: '2013-08-15T20:59:00.001+01:00'
author: Frans Lytzen
tags: Azure
modified_time: '2015-11-12T17:31:10.536Z'
blogger_id: tag:blogger.com,1999:blog-8302357413081836531.post-4402589038424025298
blogger_orig_url: http://blog.lytzen.name/2013/08/continuous-deployment-to-azure-cloud.html
---

When you use Azure Websites you can do continuous deployment using Git, but with cloud services you can only do it from TFS. Luckily, it is quite easy to set up a Powershell script to deploy to Cloud Services. In this post I will share a sample script that can be used to deploy to multiple different environments, such as a UAT and a Live environment. I am assuming that you have set up corresponding UAT and Live Build and Azure profiles. The reason for this is that you can then easily use Web.Config transformation to change settings between UAT and Live and also use the two different Azure configurations to have different Azure settings. If you need to do an app.config transformation for your worker as part of your deploy, have a look at this <a href="http://stackoverflow.com/questions/13828065/azure-worker-role-config-file-transformations/14413859#14413859">Stackoverflow answer</a>.<br />We are using this script to deploy manually as well as deploying automatically from our TeamCity server.<br /><h2>Pre-requisites</h2><ul><li>Before you start you need to <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg551722.aspx">create a Management Certificate</a> for your Azure subscription, import it on your machine and add the thumb print to the script.</li><li>You will also need to install the Azure Powershell CmdLets on your machine (it’s usually installed as part of the SDK). When you look at the script, there are a couple of values you will need to provide.</li><li>Put the script and the configuration XML file in a folder in your solution called Deployment.</li><li>Assuming you want to enable remote access to your servers, you need to create a certificate and put it in the Deployment folder next to the script. You can do this by using Visual Studio to do a deployment first and enable remote access; This will configure the config files with the thumbprint and will generate a certificate for you. If you don’t want remote access, just remove that bit of the script.</li></ul><pre class="prettyprint">Param(<br />   [string]$deploymentType,<br />   [string]$deployToAzure,<br />   [string]$slot<br />)<br /><br />$managementCertificateThumbprint="[YOURMANAGEMENTCERTIFICATETHUMBPRINT]"<br /><br />function Build()<br />{<br />    $dotNetVersion = "4.0"<br />    $regKey = "HKLM:\software\Microsoft\MSBuild\ToolsVersions\$dotNetVersion"<br />    $regProperty = "MSBuildToolsPath"<br />    $msbuildExe = join-path -path (Get-ItemProperty $regKey).$regProperty -childpath "msbuild.exe"<br />    <br />    Write-Host "Building..." -ForegroundColor Yellow<br />    &amp;$msbuildExe [YOURSOLUTIONNAME].sln /t:Publish /p:TargetProfile=$deploymentType /p:Configuration=$deploymentType /p:Platform="Any CPU" <br /><br />    if ($LASTEXITCODE -ne 0)<br />    {<br />        throw "The build failed"<br />    }<br />}<br /><br />function Deploy()<br />{<br />    Import-Module Azure<br />    write-host "`nAzure CmdLets loaded" -ForegroundColor Green<br />    $configFile = $configFolder + "\AzureSettings.xml"<br />    if (! (Test-Path $configFile))<br />    {<br />        Throw ("Unable to find " + $configFile)<br />    }<br />    [xml]$azureSettings = Get-Content ($configFile)<br />    $subscriptionId = $azureSettings.AzureSettings.SubscriptionID<br />    $friendlySubName = $azureSettings.AzureSettings.FriendlySubName<br />    $serviceSettings = ($azureSettings.AzureSettings.Services.Service | Where-Object {$_.deploymentType -match $deploymentType })<br />    $serviceName = $serviceSettings.ServiceName<br />    $storageAccount = $serviceSettings.DeploymentStorageAccount<br /><br />    if (Test-Path cert:\CurrentUser\My\$managementCertificateThumbprint)<br />    {<br />        $myCert = Get-Item cert:\CurrentUser\My\$managementCertificateThumbprint<br />    }<br />    else {<br />        if (Test-Path cert:\LocalMachine\My\$managementCertificateThumbprint) {<br />            $myCert = Get-Item cert:\LocalMachine\My\$managementCertificateThumbprint<br />        }<br />        else {<br />            Throw ("Unable to find the management certificate in either current user or local machine storage")<br />        }<br />    }<br />    Write-Host ("Adding " + $friendlySubName + " subscription") -ForegroundColor Green<br />    Set-AzureSubscription -SubscriptionName $friendlySubName -Certificate $myCert -SubscriptionID $subscriptionId<br /><br />    Select-AzureSubscription $friendlySubName<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot -ErrorVariable a -ErrorAction silentlycontinue<br />    $deploymentLabel = $deploymentType + " " + $(Get-Date –f $timeStampFormat)<br /><br />    Set-AzureSubscription -SubscriptionName $friendlySubName -CurrentStorageAccount $storageAccount<br /><br />    #Make sure we have the remote access certificate in there<br />    Add-AzureCertificate -ServiceName $serviceName -CertToDeploy ($configFolder + "\RemoteAccessCertificate.pfx") -Password powershellSucks<br /><br /> Write-Host ("About to deploy " + $deploymentType + " " + $service + " to " + $slot + " in " + $location) -ForegroundColor Green<br /> Write-Host ("Subscription: " + $friendlySubName + ", Service: " + $serviceName + ", Storage: " + $storageAccount) -ForegroundColor Green<br /><br />    if ($a[0] -ne $null)<br />    {<br />        #Write-Host "No current deployment, creating a new deployment"<br />        CreateNewDeployment<br />    }<br />    else<br />    {<br />        Write-Host "Existing deployment, upgrading..."<br />        UpgradeDeployment<br />    }<br />}<br /><br />function CreateNewDeployment()<br />{<br />    write-progress -id 3 -activity "Creating New Deployment" -Status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Creating New Deployment: In progress"<br /><br />    $opstat = New-AzureDeployment -Slot $slot -Package $packageLocation -Configuration $cloudConfigLocation -label $deploymentLabel -ServiceName $serviceName<br /><br />    $completeDeployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $completeDeploymentID = $completeDeployment.deploymentid<br /><br />    write-progress -id 3 -activity "Creating New Deployment" -completed -Status "Complete"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Creating New Deployment: Complete, Deployment ID: $completeDeploymentID"<br /><br />    StartInstances<br />}<br /><br />function UpgradeDeployment()<br />{<br />    write-progress -id 3 -activity "Upgrading Deployment" -Status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Upgrading Deployment: In progress"<br /><br />    # perform Update-Deployment<br />    $setdeployment = Set-AzureDeployment -Upgrade -Slot $slot -Package $packageLocation -Configuration $cloudConfigLocation -label $deploymentLabel -ServiceName $serviceName -Force<br /><br />    $completeDeployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $completeDeploymentID = $completeDeployment.deploymentid<br /><br />    write-progress -id 3 -activity "Upgrading Deployment" -completed -Status "Complete"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Upgrading Deployment: Complete, Deployment ID: $completeDeploymentID"<br />}<br /><br />function StartInstances()<br />{<br />    write-progress -id 4 -activity "Starting Instances" -status "In progress"<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instances: In progress"<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $runstatus = $deployment.Status<br /><br />    if ($runstatus -ne 'Running') <br />    {<br />        $run = Set-AzureDeployment -Slot $slot -ServiceName $serviceName -Status Running<br />    }<br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $oldStatusStr = @("") * $deployment.RoleInstanceList.Count<br /><br />    while (-not(AllInstancesRunning($deployment.RoleInstanceList)))<br />    {<br />        $i = 1<br />        foreach ($roleInstance in $deployment.RoleInstanceList)<br />        {<br />            $instanceName = $roleInstance.InstanceName<br />            $instanceStatus = $roleInstance.InstanceStatus<br /><br />            if ($oldStatusStr[$i - 1] -ne $roleInstance.InstanceStatus)<br />            {<br />                $oldStatusStr[$i - 1] = $roleInstance.InstanceStatus<br />                Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instance '$instanceName': $instanceStatus"<br />            }<br /><br />            write-progress -id (4 + $i) -activity "Starting Instance '$instanceName'" -status "$instanceStatus"<br />            $i = $i + 1<br />        }<br /><br />        sleep -Seconds 1<br /><br />        $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    }<br /><br />    $i = 1<br />    foreach ($roleInstance in $deployment.RoleInstanceList)<br />    {<br />        $instanceName = $roleInstance.InstanceName<br />        $instanceStatus = $roleInstance.InstanceStatus<br /><br />        if ($oldStatusStr[$i - 1] -ne $roleInstance.InstanceStatus)<br />        {<br />            $oldStatusStr[$i - 1] = $roleInstance.InstanceStatus<br />            Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instance '$instanceName': $instanceStatus"<br />        }<br /><br />        $i = $i + 1<br />    }<br /><br />    $deployment = Get-AzureDeployment -ServiceName $serviceName -Slot $slot<br />    $opstat = $deployment.Status <br /><br />    write-progress -id 4 -activity "Starting Instances" -completed -status $opstat<br />    Write-Output "$(Get-Date -f $timeStampFormat) - Starting Instances: $opstat"<br />}<br /><br />function AllInstancesRunning($roleInstanceList)<br />{<br />    foreach ($roleInstance in $roleInstanceList)<br />    {<br />        if ($roleInstance.InstanceStatus -ne "ReadyRole")<br />        {<br />            return $false<br />        }<br />    }<br /><br />    return $true<br />}<br /><br />#Get to the right place...<br />$scriptPath = $MyInvocation.MyCommand.Path<br />$dir = Split-Path $scriptPath<br />cd $dir<br />cd..<br /><br />$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")<br />if (!$isAdmin)<br />{<br />    throw "You need to run this script as an admin"<br />}<br /><br />$configFolder = "Deployment"<br />if (!(Test-Path $configFolder))<br />{<br />    Throw ("There is no '" + $configFolder + "' folder. Aborting.")<br />}<br /><br />while ((!$deploymentType) -OR ($deploymentType -notin ("Live", "UAT", "Dev" )))<br />{<br />    $deploymentType = Read-Host "Please specify deployment type Live or UAT (or Dev)"<br />}<br /><br />while ((!$slot) -or ($slot -notin ("Production", "Staging")))<br />{<br />    $slot = Read-Host "Deploy to Production or Staging?"<br />}<br /><br />Build<br /><br />while ((!$deployToAzure ) -or ($deployToAzure -notin ("Y", "N")))<br />{<br />    $deployToAzure = Read-Host "Do you want to actually deploy this to Azure now (Y/N)?"<br />}<br /><br />if ($deployToAzure -eq "Y")<br />{<br />    $packageLocation = $dir + "\..\Cloud\bin\" + $deploymentType + "\app.publish\Cloud.cspkg"<br />    $cloudConfigLocation = $dir + "\..\Cloud\bin\" + $deploymentType + "\app.publish\ServiceConfiguration." + $deploymentType + ".cscfg"<br />    Deploy<br />}<br /></pre><br />Note that some of the above scripts have been found elsewhere on the internet, in particular the functions to actuall create/upgrade deployments.<br /><br />You will also need a configuration file to hold some information about each of your environments:<br /><pre class="prettyprint">&lt;azuresettings&gt;<br />  &lt;subscriptionid&gt;[SUBSCRIPTIONID]&lt;/subscriptionid&gt;<br />  &lt;friendlysubname&gt;[WHATEVERYOUWANT]&lt;/friendlysubname&gt;<br />    &lt;services&gt;<br />      &lt;service deploymenttype="UAT"&gt;<br />        &lt;servicename&gt;[CLOUDSERVICENAME eg myuatcloudservice]&lt;/servicename&gt;<br />        &lt;deploymentstorageaccount&gt;[STORAGEACCOUNTNAME eg myuatstorage]&lt;/deploymentstorageaccount&gt;<br />      &lt;/service&gt;<br />    &lt;/services&gt;<br />  &lt;services&gt;<br />    &lt;service deploymenttype="Live"&gt;<br />      &lt;servicename&gt;[CLOUDSERVICENAME eg myuatcloudservice]&lt;/servicename&gt;<br />      &lt;deploymentstorageaccount&gt;[STORAGEACCOUNTNAME eg myuatstorage]&lt;/deploymentstorageaccount&gt;<br />    &lt;/service&gt;<br />  &lt;/services&gt;<br />&lt;/azuresettings&gt;</pre>