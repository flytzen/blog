---
layout: post
title: How to Mock RestSharp.ExecuteAsync
date: '2013-01-10T20:35:00.001Z'
author: Frans Lytzen
tags: Testing
modified_time: '2015-11-12T17:46:37.299Z'
blogger_id: tag:blogger.com,1999:blog-8302357413081836531.post-4706210040796821390
blogger_orig_url: http://blog.lytzen.name/2013/01/how-to-mock-restsharpexecuteasync.html
---

It took me a while to figure out how to Mock RestSharp’s ExecuteAsync method for unit testing purposes. Once you realise that ExecuteAsync takes a callback which is called when the REST call completes it all becomes reasonably straightforward, using Mocks Callback function;<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:33beae74-eabd-4126-a56d-8c29a9058179" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="prettyprint">Mock&lt;IRestClient&gt; restClient = new Mock&lt;IRestClient&gt;();<br />            restClient.Setup(c =&gt; c.ExecuteAsync&lt;MyResult&gt;(<br />                    Moq.It.IsAny&lt;IRestRequest&gt;(), <br />                    Moq.It.IsAny&lt;Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;()))<br />                .Callback&lt;IRestRequest, Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;((request, callback) =&gt;<br />                {<br />                    var responseMock = new Mock&lt;IRestResponse&lt;MyResult&gt;&gt;();<br />                    responseMock.Setup(r =&gt; r.Data).Returns(new MyResult() { Foo = "Bar" });<br />                    callback(responseMock.Object, null);<br />                });</pre></div><br />In my scenario I wanted to use the built-deserialization and return a “MyResult".<br />This means that ExecuteAsync takes two parameters:<br /><ul><li>An IRestRequest </li><li>A callback, which is an Action&lt;IRestResponse&lt;AuthorisationResponse&gt;, RestRequestAsyncHandle&gt; <br /><br />That is just the callback you pass in and it is a delegate that takes two parameters, namely the IRestResponse and a RestRequestAsyncHandle. </li></ul>When you are running this for real, RestSharp will execute your IRestRequest and then call your callback with the result. So in our Unit test, we can use Mock’s Callback feature to call your callback straight away. To your code that will just look like the website responded really quickly.<br /><br />When I actually call the callback function, I also use Mock to mock the IRestResponse and just configure that mock to return a concrete instance of MyResult. <br /><br /><h2>EDIT 9 November 2013</h2>A fuller example:<br /><br /><pre class="prettyprint">public class Sud<br />{<br />    private IRestClient client;<br /><br />    public Sud(IRestClient client)<br />    {<br />        this.client = client;<br />    }<br /><br />    public MyResult Foo()<br />    {<br />        // NOTE: This code is obviously stupid; it just blocks the thread until the async task completes, which is rather pointless.<br />        // It's just an example :)<br />        MyResult result = null;<br />        var request = new RestRequest();<br />        var blocker = new AutoResetEvent(false);<br /><br />        this.client.ExecuteAsync&lt;MyResult&gt;(<br />            request, <br />            response =&gt;<br />            {<br />                result = response.Data;<br />                blocker.Set();<br />            });<br />        blocker.WaitOne();<br />        return result;<br />    }<br />}<br /><br />public class MyResult<br />{<br />    public string Name { get; set; }<br />}<br /><br />[TestFixture]<br />public class Tests<br />{<br />    [Test]<br />    public void TestFoo()<br />    {<br />        Mock&lt;IRestClient&gt; restClient = new Mock&lt;IRestClient&gt;();<br />        restClient.Setup(c =&gt; c.ExecuteAsync&lt;MyResult&gt;(<br />                Moq.It.IsAny&lt;IRestRequest&gt;(),<br />                Moq.It.IsAny&lt;Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;()))<br />            .Callback&lt;IRestRequest, Action&lt;IRestResponse&lt;MyResult&gt;, RestRequestAsyncHandle&gt;&gt;((request, callback) =&gt;<br />            {<br />                var responseMock = new Mock&lt;IRestResponse&lt;MyResult&gt;&gt;();<br />                responseMock.Setup(r =&gt; r.Data).Returns(new MyResult() { Name = &quot;Billy Bob&quot; });<br />                callback(responseMock.Object, null);<br />            });<br /><br />        var Subject = new Sud(restClient.Object);<br /><br />        var result = Subject.Foo();<br /><br />        Assert.IsNotNull(result);<br />        Assert.AreEqual(&quot;Billy Bob&quot;, result.Name);<br />    }<br />}<br /></pre>